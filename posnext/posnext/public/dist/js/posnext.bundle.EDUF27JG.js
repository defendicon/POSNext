(()=>{var C=Object.defineProperty,S=Object.defineProperties;var q=Object.getOwnPropertyDescriptors;var w=Object.getOwnPropertySymbols;var P=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable;var k=(e,t,i)=>t in e?C(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,u=(e,t)=>{for(var i in t||(t={}))P.call(t,i)&&k(e,i,t[i]);if(w)for(var i of w(t))O.call(t,i)&&k(e,i,t[i]);return e},v=(e,t)=>S(e,q(t));frappe.provide("posnext.PointOfSale");var f=null;posnext.PointOfSale.Controller=class{constructor(e){console.log("CONTROLLLLLERE"),this.wrapper=$(e).find(".layout-main-section"),this.page=e.page,this.add_ledger_balance_box(),frappe.run_serially([()=>this.reload_status=!1,()=>this.check_opening_entry(""),()=>this.reload_status=!0])}add_ledger_balance_box(){let e=(s,o)=>{let n=document.getElementById("ledger-balance-box");n||(n=document.createElement("div"),n.id="ledger-balance-box",n.style.marginTop="10px",n.style.padding="10px",n.style.border="1px solid #ccc",n.style.borderRadius="4px",n.style.backgroundColor="#f0f8ff",n.style.fontWeight="bold",s.appendChild(n)),n.textContent=`Ledger Balance: Rs. ${o}`},t=async s=>{try{return(await frappe.call({method:"posnext.controllers.queries.get_ledger_balance",args:{customer:s}})).message||"0.00"}catch(o){return console.error("Failed to fetch ledger balance:",o),"Error"}};new MutationObserver(async()=>{let s=document.querySelector(".customer-section");if(s){let o=s.querySelector(".reset-customer-btn"),n=o==null?void 0:o.getAttribute("data-customer");if(n&&n!=="undefined"){let a=await t(n);e(s,a)}else e(s,"Select a Customer")}}).observe(document.body,{childList:!0,subtree:!0})}fetch_opening_entry(e){return frappe.call("posnext.posnext.page.posnext.point_of_sale.check_opening_entry",{user:frappe.session.user,value:e})}check_opening_entry(e=""){this.fetch_opening_entry(e).then(t=>{t.message.length?this.prepare_app_defaults(t.message[0]):this.create_opening_voucher()})}create_opening_voucher(){let e=this,t=[{fieldname:"mode_of_payment",fieldtype:"Link",in_list_view:1,label:"Mode of Payment",options:"Mode of Payment",reqd:1},{fieldname:"opening_amount",fieldtype:"Currency",in_list_view:1,label:"Opening Amount",options:"company:company_currency",change:function(){s.fields_dict.balance_details.df.data.some(n=>{if(n.idx==this.doc.idx)return n.opening_amount=this.value,s.fields_dict.balance_details.grid.refresh(),!0})}}],i=()=>{let n=s.fields_dict.pos_profile.get_value();!n||frappe.db.get_doc("POS Profile",n).then(({payments:a})=>{s.fields_dict.balance_details.df.data=[],a.forEach(r=>{let{mode_of_payment:c}=r;s.fields_dict.balance_details.df.data.push({mode_of_payment:c,opening_amount:"0"})}),s.fields_dict.balance_details.grid.refresh()})},s=new frappe.ui.Dialog({title:__("Create POS Opening Entry"),static:!0,fields:[{fieldtype:"Link",label:__("Company"),default:frappe.defaults.get_default("company"),options:"Company",fieldname:"company",reqd:1},{fieldtype:"Link",label:__("POS Profile"),options:"POS Profile",fieldname:"pos_profile",reqd:1,get_query:()=>o(),onchange:()=>i()},{fieldname:"balance_details",fieldtype:"Table",label:"Opening Balance Details",cannot_add_rows:!1,in_place_edit:!0,reqd:1,data:[],fields:t}],primary_action:async function({company:n,pos_profile:a,balance_details:r}){if(!r.length)return frappe.show_alert({message:__("Please add Mode of payments and opening balance details."),indicator:"red"}),frappe.utils.play_sound("error");r=r.filter(l=>l.mode_of_payment);let c="posnext.posnext.page.posnext.point_of_sale.create_opening_voucher",m=await frappe.call({method:c,args:{pos_profile:a,company:n,balance_details:r},freeze:!0});!m.exc&&e.prepare_app_defaults(m.message),s.hide()},primary_action_label:__("Submit")});s.show();let o=()=>({query:"erpnext.accounts.doctype.pos_profile.pos_profile.pos_profile_query",filters:{company:s.fields_dict.company.get_value()}})}async prepare_app_defaults(e){this.pos_opening=e.name,this.company=e.company,this.pos_profile=e.pos_profile,this.pos_opening_time=e.period_start_date,this.item_stock_map={},this.settings={},window.current_pos_profile=this.pos_profile,frappe.db.get_value("Stock Settings",void 0,"allow_negative_stock").then(({message:t})=>{this.allow_negative_stock=flt(t.allow_negative_stock)||!1}),frappe.call({method:"posnext.posnext.page.posnext.point_of_sale.get_pos_profile_data",args:{pos_profile:this.pos_profile},callback:t=>{let i=t.message;Object.assign(this.settings,i),this.settings.customer_groups=i.customer_groups.map(s=>s.name),this.make_app()}})}set_opening_entry_status(){this.page.set_title_sub(`<span class="indicator orange">
				<a class="text-muted" href="#Form/POS%20Opening%20Entry/${this.pos_opening}">
					Opened at ${moment(this.pos_opening_time).format("Do MMMM, h:mma")}
				</a>
			</span>`)}make_app(){this.prepare_dom(),this.prepare_components(),this.prepare_menu(),this.make_new_invoice()}prepare_dom(){this.wrapper.append('<div class="point-of-sale-app"></div>'),this.$components_wrapper=this.wrapper.find(".point-of-sale-app")}prepare_components(){this.init_item_selector(),this.init_item_details(),this.init_item_cart(),this.init_payments(),this.init_recent_order_list(),this.init_order_summary()}prepare_menu(){this.page.clear_menu(),this.settings.custom_show_open_form_view&&this.page.add_menu_item(__("Open Form View"),this.open_form_view.bind(this),!1,"Ctrl+F"),this.settings.custom_show_toggle_recent_orders&&this.page.add_menu_item(__("Toggle Recent Orders"),this.toggle_recent_order.bind(this),!1,"Ctrl+O"),this.settings.custom_show_save_as_draft&&this.page.add_menu_item(__("Save as Draft"),this.save_draft_invoice.bind(this),!1,"Ctrl+S"),this.settings.custom_show_close_the_pos&&this.page.add_menu_item(__("Close the POS"),this.close_pos.bind(this),!1,"Shift+Ctrl+C")}open_form_view(){frappe.model.sync(this.frm.doc),frappe.set_route("Form",this.frm.doc.doctype,this.frm.doc.name)}toggle_recent_order(){let e=this.recent_order_list.$component.is(":hidden");this.toggle_recent_order_list(e)}save_draft_invoice(){if(!!this.$components_wrapper.is(":visible")){if(console.log(this.frm.doc.items),this.frm.doc.items.length==0){frappe.show_alert({message:__("You must add atleast one item to save it as draft."),indicator:"red"}),frappe.utils.play_sound("error");return}this.frm.save(void 0,void 0,void 0,()=>{frappe.show_alert({message:__("There was an error saving the document."),indicator:"red"}),frappe.utils.play_sound("error")}).then(()=>{frappe.run_serially([()=>frappe.dom.freeze(),()=>this.make_new_invoice(!0),()=>frappe.dom.unfreeze()])})}}close_pos(){if(!this.$components_wrapper.is(":visible"))return;let e=frappe.model.get_new_doc("POS Closing Entry");e.pos_profile=this.frm.doc.pos_profile,e.user=frappe.session.user,e.company=this.frm.doc.company,e.pos_opening_entry=this.pos_opening,e.period_end_date=frappe.datetime.now_datetime(),e.posting_date=frappe.datetime.now_date(),e.posting_time=frappe.datetime.now_time(),frappe.set_route("Form","POS Closing Entry",e.name)}init_item_selector(){this.frm&&(this.frm.doc.set_warehouse=this.settings.warehouse),this.item_selector=new posnext.PointOfSale.ItemSelector({wrapper:this.$components_wrapper,pos_profile:this.pos_profile,settings:this.settings,reload_status:this.reload_status,currency:this.settings.currency,events:{check_opening_entry:()=>this.check_opening_entry(),item_selected:e=>this.on_cart_update(e),init_item_cart:()=>this.init_item_cart(),init_item_details:()=>this.init_item_details(),change_items:e=>this.change_items(e),get_frm:()=>this.frm||{}}})}change_items(e){var t=this;this.frm=e,this.cart.load_invoice()}init_item_cart(){this.cart=new posnext.PointOfSale.ItemCart({wrapper:this.$components_wrapper,settings:this.settings,events:{get_frm:()=>this.frm,remove_item_from_cart:e=>{this.item_details.current_item=e,this.item_details.name=e.name,this.item_details.doctype=e.doctype},form_updated:(e,t,i)=>{this.item_details.current_item=e;let s=frappe.model.get_doc(e.doctype,e.name);if(t==="qty"&&this.frm.doc.is_return&&i>=0&&frappe.throw("Qty must be negative for return document"),s&&s[t]!=i){let o={field:t,value:i,item:this.item_details.current_item};return this.on_cart_update(o)}return Promise.resolve()},cart_item_clicked:e=>{let t=this.get_item_from_frm(e);f&&f.name==e.name?f=null:f=t,this.item_details.toggle_item_details_section(t)},numpad_event:(e,t)=>this.update_item_field(e,t),checkout:()=>this.save_and_checkout(),edit_cart:()=>this.payment.edit_cart(),save_draft_invoice:()=>this.save_draft_invoice(),toggle_recent_order:()=>this.toggle_recent_order(),customer_details_updated:e=>{this.customer_details=e,this.payment.render_loyalty_points_payment_mode()}}})}init_item_details(){this.item_details=new posnext.PointOfSale.ItemDetails({wrapper:this.$components_wrapper,settings:this.settings,events:{get_frm:()=>this.frm,toggle_item_selector:e=>{this.item_selector.resize_selector(e),this.cart.toggle_numpad(e)},form_updated:(e,t,i)=>{let s=frappe.model.get_doc(e.doctype,e.name);if(t==="qty"&&this.frm.doc.is_return&&i>=0&&frappe.throw("Qty must be negative for return document"),s&&s[t]!=i){let o={field:t,value:i,item:this.item_details.current_item};return this.on_cart_update(o)}return Promise.resolve()},highlight_cart_item:e=>{let t=this.cart.get_cart_item(e);this.cart.toggle_item_highlight(t)},item_field_focused:e=>{this.cart.toggle_numpad_field_edit(e)},set_value_in_current_cart_item:(e,t)=>{this.cart.update_selector_value_in_cart_item(e,t,this.item_details.current_item)},clone_new_batch_item_in_frm:(e,t)=>{Object.keys(e).forEach(i=>{let s=this.frm.doc.items.find(n=>n.name==t.name),o=this.frm.add_child("items",u({},s));o.batch_no=i,o.serial_no=e[i].join(`
`),o.qty=e[i].length,this.frm.doc.items.forEach(n=>{t.item_code===n.item_code&&this.update_cart_html(n)})})},remove_item_from_cart:()=>this.remove_item_from_cart(),get_item_stock_map:()=>this.item_stock_map,close_item_details:()=>{f=null,this.item_details.toggle_item_details_section(null),this.cart.prev_action=null,this.cart.toggle_item_highlight()},get_available_stock:(e,t)=>this.get_available_stock(e,t)}}),f&&this.item_details.toggle_item_details_section(f)}init_payments(){this.payment=new posnext.PointOfSale.Payment({wrapper:this.$components_wrapper,settings:this.settings,events:{get_frm:()=>this.frm||{},get_customer_details:()=>this.customer_details||{},toggle_other_sections:e=>{e?(this.item_details.$component.is(":visible")&&this.item_details.$component.css("display","none"),this.item_selector.toggle_component(!1)):this.item_selector.toggle_component(!0)},submit_invoice:()=>{this.frm.savesubmit().then(e=>{this.toggle_components(!1),this.order_summary.toggle_component(!0),this.order_summary.load_summary_of(this.frm.doc,!0),frappe.show_alert({indicator:"green",message:__("POS invoice {0} created succesfully",[e.doc.name])})})}}})}init_recent_order_list(){this.recent_order_list=new posnext.PointOfSale.PastOrderList({wrapper:this.$components_wrapper,events:{open_invoice_data:e=>{frappe.db.get_doc("Sales Invoice",e).then(t=>{this.order_summary.load_summary_of(t)})},reset_summary:()=>this.order_summary.toggle_summary_placeholder(!0),previous_screen:()=>{this.recent_order_list.toggle_component(!1),this.cart.load_invoice(),this.item_selector.toggle_component(!0),this.wrapper.find(".past-order-summary").css("display","none")}},settings:this.settings})}init_order_summary(){this.order_summary=new posnext.PointOfSale.PastOrderSummary({wrapper:this.$components_wrapper,pos_profile:this.settings,events:{get_frm:()=>this.frm,process_return:e=>{this.recent_order_list.toggle_component(!1),frappe.db.get_doc("Sales Invoice",e).then(t=>{frappe.run_serially([()=>this.make_return_invoice(t),()=>this.cart.load_invoice(),()=>this.item_selector.toggle_component(!0)])})},edit_order:e=>{console.log("Edit Order..."),this.recent_order_list.toggle_component(!1),frappe.run_serially([()=>this.frm.refresh(e),()=>this.frm.call("reset_mode_of_payments"),()=>this.cart.load_invoice(),()=>this.item_selector.toggle_component(!0)])},delete_order:e=>{frappe.model.delete_doc(this.frm.doc.doctype,e,()=>{this.recent_order_list.refresh_list()})},new_order:()=>{frappe.run_serially([()=>frappe.dom.freeze(),()=>this.make_new_invoice(),()=>this.item_selector.toggle_component(!0),()=>frappe.dom.unfreeze()])}}})}toggle_recent_order_list(e){this.toggle_components(!e),this.recent_order_list.toggle_component(e),this.order_summary.toggle_component(e)}toggle_components(e){this.cart.toggle_component(e),this.item_selector.toggle_component(e),e||this.item_details.toggle_component(!1)||this.payment.toggle_component(!1)}make_new_invoice(e=!1){return e?frappe.run_serially([()=>frappe.dom.freeze(),()=>this.make_sales_invoice_frm(),()=>this.set_pos_profile_data(),()=>this.set_pos_profile_status(),()=>this.cart.load_invoice(),()=>frappe.dom.unfreeze(),()=>this.toggle_recent_order()]):frappe.run_serially([()=>frappe.dom.freeze(),()=>this.make_sales_invoice_frm(),()=>this.set_pos_profile_data(),()=>this.set_pos_profile_status(),()=>this.cart.load_invoice(),()=>frappe.dom.unfreeze()])}make_sales_invoice_frm(){let e="Sales Invoice";return new Promise(t=>{this.frm?(this.frm=this.get_new_frm(this.frm),this.frm.doc.items=[],this.frm.doc.is_pos=1,this.frm.doc.set_warehouse=this.settings.warehouse,t()):frappe.model.with_doctype(e,()=>{this.frm=this.get_new_frm(),this.frm.doc.items=[],this.frm.doc.is_pos=1,this.frm.doc.set_warehouse=this.settings.warehouse,t()})})}get_new_frm(e){let t="Sales Invoice",i=$("<div>"),s=e||new frappe.ui.form.Form(t,i,!1),o=frappe.model.make_new_doc_and_get_name(t,!0);return s.refresh(o),s}async make_return_invoice(e){return frappe.dom.freeze(),this.frm=this.get_new_frm(this.frm),this.frm.doc.items=[],frappe.call({method:"posnext.posnext.page.posnext.point_of_sale.make_sales_return",args:{source_name:e.name,target_doc:this.frm.doc},callback:t=>{frappe.model.sync(t.message),frappe.get_doc(t.message.doctype,t.message.name).__run_link_triggers=!1,this.set_pos_profile_data().then(()=>{frappe.dom.unfreeze()})}})}set_pos_profile_data(){if(this.company&&!this.frm.doc.company&&(this.frm.doc.company=this.company),(this.pos_profile&&!this.frm.doc.pos_profile)|(this.frm.doc.is_return&&this.pos_profile!=this.frm.doc.pos_profile)&&(this.frm.doc.pos_profile=this.pos_profile),!!this.frm.doc.company)return this.frm.trigger("set_pos_data")}set_pos_profile_status(){this.page.set_indicator(this.pos_profile,"blue")}async on_cart_update(e){let t;try{let{field:s,value:o,item:n}=e;t=this.get_item_from_frm(n);let a=!$.isEmptyObject(t),r=s==="qty"&&o==="+1";if(r&&(o=flt(t.stock_qty)+flt(o)),a){if(s==="qty"&&(o=flt(o)),["qty","conversion_factor"].includes(s)&&o>0&&!this.allow_negative_stock){let c=s==="qty"?o*t.conversion_factor:t.qty*o}(this.is_current_item_being_edited(t)||r)&&await frappe.model.set_value(t.doctype,t.name,s,o)}else{if(!this.frm.doc.customer&&!this.settings.custom_mobile_number_based_customer)return this.raise_customer_selection_alert();frappe.flags.ignore_company_party_validation=!0;let{item_code:c,batch_no:m,serial_no:l,rate:d,uom:_,valuation_rate:p,custom_item_uoms:g,custom_logical_rack:y}=n;if(!c)return;let b={item_code:c,batch_no:m,rate:d,uom:_,[s]:o};o&&(b.qty=o),l&&(await this.check_serial_no_availablilty(c,this.frm.doc.set_warehouse,l),b.serial_no=l),s==="serial_no"&&(b.qty=o.split(`
`).length||0),t=this.frm.add_child("items",b),await this.trigger_new_item_events(t),t.rate=d,t.valuation_rate=p,t.custom_valuation_rate=p,t.custom_item_uoms=g,t.custom_logical_rack=y,this.item_details.$component.is(":visible")&&this.edit_item_details_of(t),this.check_serial_batch_selection_needed(t)&&!this.item_details.$component.is(":visible")&&this.edit_item_details_of(t)}}catch(s){console.log(s)}finally{var i=0;return this.frm.doc.items.forEach(s=>{i+=parseFloat(s.valuation_rate)*s.qty}),this.item_selector.update_total_incoming_rate(i),t}}raise_customer_selection_alert(){frappe.dom.unfreeze(),frappe.show_alert({message:__("You must select a customer before adding an item."),indicator:"orange"}),frappe.utils.play_sound("error")}get_item_from_frm({name:e,item_code:t,batch_no:i,uom:s,rate:o}){let n=null;if(e)n=this.frm.doc.items.find(r=>r.name==e);else{let r=i!=="null"&&i!==null,c=this.settings.custom_allow_add_new_items_on_new_line?r&&cur_frm.doc.items[a].batch_no===i:!0;for(var a=0;a<cur_frm.doc.items.length;a+=1)if(cur_frm.doc.items[a].item_code===t&&cur_frm.doc.items[a].uom===s&&parseFloat(cur_frm.doc.items[a].rate)===parseFloat(o)){n=cur_frm.doc.items[a];break}console.log(n)}return n||{}}edit_item_details_of(e){this.item_details.toggle_item_details_section(e)}is_current_item_being_edited(e){return e.name==this.item_details.current_item.name}update_cart_html(e,t){this.cart.update_item_html(e,t),this.cart.update_totals_section(this.frm)}check_serial_batch_selection_needed(e){let t=e.has_serial_no,i=e.has_batch_no,s=!e.serial_no,o=!e.batch_no;return!!(t&&s||i&&o||t&&i&&(o||s))}async trigger_new_item_events(e){await this.frm.script_manager.trigger("item_code",e.doctype,e.name),await this.frm.script_manager.trigger("qty",e.doctype,e.name),await this.frm.script_manager.trigger("discount_percentage",e.doctype,e.name)}async check_stock_availability(e,t,i){let s=(await this.get_available_stock(e.item_code,i)).message,o=s[0],n=s[1];frappe.dom.unfreeze();let a=e.uom.bold(),r=e.item_code.bold(),c=i.bold(),m=o.toString().bold();if(o>0)n&&o<t&&(frappe.throw({message:__("Stock quantity not enough for Item Code: {0} under warehouse {1}. Available quantity {2} {3}.",[r,c,m,a]),indicator:"orange"}),frappe.utils.play_sound("error"));else if(n)frappe.model.clear_doc(e.doctype,e.name),frappe.throw({title:__("Not Available"),message:__("Item Code: {0} is not available under warehouse {1}.",[r,c])});else return;frappe.dom.freeze()}async check_serial_no_availablilty(e,t,i){let s="erpnext.stock.doctype.serial_no.serial_no.get_pos_reserved_serial_nos",o={filters:{item_code:e,warehouse:t}};(await frappe.call({method:s,args:o})).message.includes(i)&&frappe.throw({title:__("Not Available"),message:__("Serial No: {0} has already been transacted into another Sales Invoice.",[i.bold()])})}get_available_stock(e,t){let i=this;return frappe.call({method:"erpnext.accounts.doctype.pos_invoice.pos_invoice.get_stock_availability",args:{item_code:e,warehouse:t},callback(s){i.item_stock_map[e]||(i.item_stock_map[e]={}),i.item_stock_map[e][t]=s.message}})}update_item_field(e,t){if(t==="checkout")this.item_details.toggle_item_details_section(null);else if(t==="remove")this.remove_item_from_cart();else{let i=this.item_details[`${t}_control`];if(!i)return;i.set_focus(),e!=""&&i.set_value(e)}}remove_item_from_cart(){frappe.dom.freeze();let{doctype:e,name:t,current_item:i}=this.item_details;return frappe.model.set_value(e,t,"qty",0).then(()=>{frappe.model.clear_doc(e,t),this.update_cart_html(i,!0),this.item_details.toggle_item_details_section(null),frappe.dom.unfreeze();var s=0;this.frm.doc.items.forEach(o=>{s+=parseFloat(o.valuation_rate)*o.qty}),this.item_selector.update_total_incoming_rate(s)}).catch(s=>console.log(s))}async save_and_checkout(){if(this.frm.is_dirty()){let e=document.getElementById("customer-cart-container2");e.style.gridColumn="";let t=!1;await this.frm.save(null,null,null,()=>t=!0),!t&&this.payment.checkout(),t&&setTimeout(()=>{this.cart.toggle_checkout_btn(!0)},300)}else this.payment.checkout()}};frappe.provide("posnext.PointOfSale");var h="List";posnext.PointOfSale.ItemSelector=class{constructor({frm:e,wrapper:t,events:i,pos_profile:s,settings:o,currency:n,init_item_cart:a,reload_status:r}){this.wrapper=t,this.events=i,this.currency=n,this.pos_profile=s,this.hide_images=o.hide_images,this.reload_status=r,this.auto_add_item=o.auto_add_item_to_cart,o.custom_default_view&&(h=o.custom_default_view),o.custom_show_only_list_view&&(h="List"),o.custom_show_only_card_view&&(h="Card"),this.custom_show_item_code=o.custom_show_item_code,this.custom_show_last_incoming_rate=o.custom_show_last_incoming_rate,this.custom_show_oem_part_number=o.custom_show_oem_part_number,this.custom_show_posting_date=o.custom_show_posting_date,this.custom_show_logical_rack=o.custom_show_logical_rack,this.show_only_list_view=o.custom_show_only_list_view,this.show_only_card_view=o.custom_show_only_card_view,this.custom_edit_rate=o.custom_edit_rate_and_uom,this.custom_show_incoming_rate=o.custom_show_incoming_rate&&o.custom_edit_rate_and_uom,this.inti_component()}inti_component(){this.prepare_dom(),this.make_search_bar(),this.load_items_data(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){var e="";if(!this.show_only_list_view&&!this.show_only_card_view&&(e=`<div class="list-view"><a class="list-span">List</a></div>
			<div class="card-view"><a class="card-span">Card</a></div>`),h==="Card"&&!this.show_only_list_view){var t="";(this.custom_show_last_incoming_rate||this.custom_show_incoming_rate)&&(t='<div class="total-incoming-rate" style="margin-left: 10px;grid-column: span 2 / span 2"></div>'),this.wrapper.append(`<div class="items-container">
					<section class="items-selector" id="card-view-section">
						<div class="filter-section">`+e+`
							
							<div class="pos-profile" style="grid-column: span 2 / span 2"></div>
							<div class="search-field" style="grid-column: span 4 / span 4"></div>
							<!--<div class="item-code-search-field" style="grid-column: span 2 / span 2"></div>-->
							<div class="item-group-field" style="grid-column: span 2 / span 2"></div>
							<div class="invoice-posting-date" style="grid-column: span 2 / span 2"></div>
							`+t+`
						</div>
						<div class="items-container"></div>
					</section>
				</div>`),this.$component=this.wrapper.find(".items-selector"),this.$items_container=this.$component.find(".items-container")}else if(h==="List"&&!this.show_only_card_view){var i='<section class="customer-cart-container items-selector" id="list-view-section" style="grid-column: span 6 / span 6;overflow-y:hidden">',t="";this.custom_edit_rate&&(i='<section class="customer-cart-container items-selector" id="list-view-section" style="grid-column: span 5 / span 5;overflow-y:hidden">'),(this.custom_show_last_incoming_rate||this.custom_show_incoming_rate)&&(t='<div class="total-incoming-rate" style="margin-left: 10px;grid-column: span 2 / span 2"></div>'),this.wrapper.append(i+'<div class="filter-section">'+e+`<div class="pos-profile" style="grid-column: span 2 / span 2"></div>
						<div class="search-field" style="grid-column: span 4 / span 4"></div>
						<!--<div class="item-code-search-field" style="grid-column: span 2 / span 2"></div>-->
						<div class="item-group-field" style="grid-column: span 2 / span 2"></div>
						<div class="invoice-posting-date" style="margin-left: 10px;grid-column: span 2 / span 2"></div>`+t+`
						
					</div>
					<div class="cart-container" ></div>
				</section>`),this.$component=this.wrapper.find(".customer-cart-container"),this.$items_container=this.$component.find(".cart-container")}!this.show_only_list_view&&!this.show_only_card_view&&(this.$list_view=this.$component.find(".list-view"),this.$card_view=this.$component.find(".card-view"),h==="List"&&!this.show_only_list_view?(this.$list_view.find(".list-span").css({display:"inline-block","background-color":"#3498db",color:"white",padding:"5px 10px","border-radius":"20px","font-size":"14px","font-weight":"bold","text-transform":"uppercase","letter-spacing":"1px",cursor:"pointer",transition:"background-color 0.3s ease"}),this.$card_view.find(".card-span").css({display:"","background-color":"",color:"",padding:"","border-radius":"","font-size":"","font-weight":"","text-transform":"","letter-spacing":"",cursor:"",transition:""})):h==="Card"&&!this.show_only_card_view?(this.$card_view.find(".card-span").css({display:"inline-block","background-color":"#3498db",color:"white",padding:"5px 10px","border-radius":"20px","font-size":"14px","font-weight":"bold","text-transform":"uppercase","letter-spacing":"1px",cursor:"pointer",transition:"background-color 0.3s ease"}),this.$list_view.find(".list-span").css({display:"","background-color":"",color:"",padding:"","border-radius":"","font-size":"","font-weight":"","text-transform":"","letter-spacing":"",cursor:"",transition:""})):(this.$list_view.find(".list-span").css({display:"none"}),this.$card_view.find(".card-span").css({display:"none"})),!this.show_only_card_view&&!this.show_only_list_view&&this.click_functions())}click_functions(){this.$list_view.on("click","a",()=>{this.$list_view.find(".list-span").css({display:"inline-block","background-color":"#3498db",color:"white",padding:"5px 10px","border-radius":"20px","font-size":"14px","font-weight":"bold","text-transform":"uppercase","letter-spacing":"1px",cursor:"pointer",transition:"background-color 0.3s ease"}),this.$card_view.find(".card-span").css({display:"","background-color":"",color:"",padding:"","border-radius":"","font-size":"","font-weight":"","text-transform":"","letter-spacing":"",cursor:"",transition:""}),h="List",document.getElementById("card-view-section")&&document.getElementById("card-view-section").remove(),document.getElementById("list-view-section")&&document.getElementById("list-view-section").remove(),document.getElementById("customer-cart-container2")&&document.getElementById("customer-cart-container2").remove(),document.getElementById("item-details-container")&&document.getElementById("item-details-container").remove(),this.inti_component(),this.events.init_item_details(),this.events.init_item_cart(),this.events.change_items(this.events.get_frm())}),this.$card_view.on("click","a",()=>{this.$card_view.find(".card-span").css({display:"inline-block","background-color":"#3498db",color:"white",padding:"5px 10px","border-radius":"20px","font-size":"14px","font-weight":"bold","text-transform":"uppercase","letter-spacing":"1px",cursor:"pointer",transition:"background-color 0.3s ease"}),this.$list_view.find(".list-span").css({display:"","background-color":"",color:"",padding:"","border-radius":"","font-size":"","font-weight":"","text-transform":"","letter-spacing":"",cursor:"",transition:""}),h="Card",document.getElementById("card-view-section")&&document.getElementById("card-view-section").remove(),document.getElementById("list-view-section")&&document.getElementById("list-view-section").remove(),document.getElementById("customer-cart-container2")&&document.getElementById("customer-cart-container2").remove(),document.getElementById("item-details-container")&&document.getElementById("item-details-container").remove(),this.inti_component(),this.events.init_item_details(),this.events.init_item_cart(),this.events.change_items(this.events.get_frm())})}async load_items_data(){if(!this.item_group){let e=await frappe.db.get_value("Item Group",{lft:1,is_group:1},"name");this.parent_item_group=e.message.name}if(!this.price_list){let e=await frappe.db.get_value("POS Profile",this.pos_profile,"selling_price_list");this.price_list=e.message.selling_price_list}this.get_items({}).then(({message:e})=>{this.render_item_list(e.items)})}get_items({start:e=0,page_length:t=40,search_term:i=""}){let s=this.events.get_frm().doc,o=s&&s.selling_price_list||this.price_list,{item_group:n,pos_profile:a}=this;return!n&&(n=this.parent_item_group),frappe.call({method:"posnext.posnext.page.posnext.point_of_sale.get_items",freeze:!0,args:{start:e,page_length:t,price_list:o,item_group:n,search_term:i,pos_profile:a}})}render_item_list(e){this.$items_container.html("");var t=this;if(h==="List"){let s=function(){var o=3;!t.custom_show_item_code&&!t.custom_show_last_incoming_rate&&!t.custom_show_oem_part_number&&!t.custom_show_logical_rack&&(o=2);var n="";return t.custom_show_item_code&&(n+=`<div style="flex: 1">${__("Item Code")}</div>`),t.custom_show_last_incoming_rate&&(n+=`<div style="flex: 1">${__("Inc.Rate")}</div>`),t.custom_show_oem_part_number&&(n+=`<div style="flex: 1">${__("OEM")} <br> ${__("Part No.")}</div>`),t.custom_show_logical_rack&&(n+=`<div style="flex: 1">${__("Rack")}</div>`),o>0?'<div style="flex: '+o+`">${__("Item")}</div>`+n:`<div>${__("Item")}</div>`+n};var i=s;this.$items_container.append(`<div class="abs-cart-container" style="overflow-y:hidden">
					<div class="cart-header">
					${s()}
						<div style="flex: 1">${__("Rate")}</div>
						<div style="flex: 1">${__("Avail. Qty")}</div>
						<!--<div class="qty-header">${__("UOM")}</div>-->
					</div>
					<div class="cart-items-section" style="overflow-y:scroll;font-size: 12px"></div>
				</div>`),this.make_cart_items_section(),e.forEach(o=>{this.render_cart_item(o)})}else e.forEach(s=>{var o=this.get_item_html(s);this.$items_container.append(o)})}make_cart_items_section(){this.$cart_header=this.$component.find(".cart-header"),this.$cart_items_wrapper=this.$component.find(".cart-items-section")}get_cart_item({name:e}){let t=`.cart-item-wrapper[data-row-name="${escape(e)}"]`;return this.$cart_items_wrapper.find(t)}get_cart_item1({item_code:e}){let t=`.cart-item-wrapper[data-row-name="${escape(e)}"]`;return this.$cart_items_wrapper.find(t)}render_cart_item(e){console.log("Rener cart item"),console.log(e);let t=this,i=t.events.get_frm().currency||t.currency;this.$cart_items_wrapper.append(`<div class="cart-item-wrapper item-wrapper" 
			data-item-code="${escape(e.item_code)}" 
			data-serial-no="${escape(e.serial_no)}"
			data-batch-no="${escape(e.batch_no)}" 
			data-uom="${escape(e.uom)}"
			data-rate="${escape(e.price_list_rate||0)}"
			data-valuation-rate="${escape(e.valuation_rate||e.custom_valuation_rate)}"
			data-item-uoms="${e.custom_item_uoms}"
			data-item-logical-rack="${e.custom_logical_rack}"
			title="${e.item_name}"
			data-row-name="${escape(e.item_code)}"></div>
			<div class="seperator"></div>`);var s=this.get_cart_item1(e);s.html(`${m()}
			${o()}
			
				<div style="overflow-wrap: break-word;overflow:hidden;white-space: normal;font-weight: 700;margin-right: 10px">
					${e.item_name}
				</div>
				${c()}
			</div>
			${a()}
			${r()}`);function o(){var l=4;return t.custom_show_item_code&&t.custom_show_last_incoming_rate&&t.custom_show_oem_part_number&&(l=3),!t.custom_show_item_code&&!t.custom_show_last_incoming_rate&&!t.custom_show_oem_part_number&&!t.custom_show_logical_rack&&(l=2),'<div class="" style="flex: '+l+';overflow-wrap: break-word;overflow:hidden;white-space: normal">'}n();function n(){let l=Array.from(t.$cart_items_wrapper.find(".item-rate-amount"));t.$cart_header.find(".rate-amount-header").css("width",""),t.$cart_items_wrapper.find(".item-rate-amount").css("width","");var d=l.reduce((_,p)=>($(p).width()>_&&(_=$(p).width()),_),0);d+=1,d==1&&(d=""),t.$cart_header.find(".rate-amount-header").css("width",d),t.$cart_items_wrapper.find(".item-rate-amount").css("width",d)}function a(){var l="";if(t.custom_show_item_code){var d=1;l+='<div class="item-code-desc" style="flex: '+d+`;text-align: left">
					<div class="item-code" >
						<b>${e.item_code}</b> <br>
						${e.uom}
					</div>
				</div>`}return t.custom_show_last_incoming_rate&&(l+=`<div class="incoming-rate-desc" style="flex: 1;text-align: left">
					<div class="incoming-rate" >
						${parseFloat(e.valuation_rate).toFixed(2)}
					</div>
				</div>`),t.custom_show_oem_part_number&&(l+=`<div class="incoming-rate-desc" style="flex: 1;text-align: left">
					<div class="incoming-rate" >
						${e.custom_oem_part_number||""}
					</div>
				</div>`),t.custom_show_logical_rack&&(l+=`<div class="incoming-rate-desc" style="flex: 1;text-align: left">
					<div class="incoming-rate" >
						${e.rack||""}
					</div>
				</div>`),l}function r(){return e.rate&&e.amount&&e.rate!==e.amount?`
					<div class="item-qty-rate" style="flex: 3">
						<div class="item-rate-amount" style="flex: 1">
							<div class="item-rate" style="text-align: left">${format_currency(e.price_list_rate,i)}</div>
						</div>
						<div class="item-qty" style="flex: 1;display:block;text-align: center"><span> ${e.actual_qty||0}</span></div>
						
					</div>`:`
					<div class="item-qty-rate" style="flex: 3">
						<div class="item-rate-amount" style="flex: 1">
							<div class="item-rate" style="text-align: left">${format_currency(e.price_list_rate,i)}</div>
						</div>
						<div class="item-qty" style="flex: 1;display:block;text-align: center"><span> ${e.actual_qty||0}</span></div>
						
					</div>`}function c(){if(e.description){if(e.description.indexOf("<div>")!=-1)try{e.description=$(e.description).text()}catch(l){e.description=e.description.replace(/<div>/g," ").replace(/<\/div>/g," ").replace(/ +/g," ")}return e.description=frappe.ellipsis(e.description,45),`<div class="item-desc">${e.description}</div>`}return""}function m(){let{image:l,item_name:d}=e;return!t.hide_images&&l?`
					<div class="item-image">
						<img
							onerror="cur_pos.cart.handle_broken_image(this)"
							src="${l}" alt="${frappe.get_abbr(d)}"">
					</div>`:`<div class="item-image item-abbr">${frappe.get_abbr(d)}</div>`}}get_item_html(e){let t=this;e.currency=e.currency||t.currency;let{item_image:i,serial_no:s,batch_no:o,barcode:n,actual_qty:a,uom:r,price_list_rate:c}=e,m=flt(c,2)%1!=0?2:0,l,d=a;e.is_stock_item?(l=a>10?"green":a<=0?"red":"orange",Math.round(d)>999&&(d=Math.round(d)/1e3,d=d.toFixed(1)+"K")):(l="",d="");function _(){return!t.hide_images&&i?`<div class="item-qty-pill">
							<span class="indicator-pill whitespace-nowrap ${l}">${d}</span>
						</div>
						<div class="flex items-center justify-center h-32 border-b-grey text-6xl text-grey-100">
							<img
								onerror="cur_pos.item_selector.handle_broken_image(this)"
								class="h-full item-img" src="${i}"
								alt="${frappe.get_abbr(e.item_name)}"
							>
						</div>`:`<div class="item-qty-pill">
							<span class="indicator-pill whitespace-nowrap ${l}">${d}</span>
						</div>
						<div class="item-display abbr">${frappe.get_abbr(e.item_name)}</div>`}return`<div class="item-wrapper"
				data-item-code="${escape(e.item_code)}" data-serial-no="${escape(s)}"
				data-batch-no="${escape(o)}" data-uom="${escape(r)}"
				data-rate="${escape(c||0)}"
				title="${e.item_name}">

				${_()}

				<div class="item-detail">
					<div class="item-name">
						${frappe.ellipsis(e.item_name,18)}
					</div>
					<div class="item-rate">${format_currency(c,e.currency,m)||0} / ${r}</div>
				</div>
			</div>`}handle_broken_image(e){let t=$(e).attr("alt");$(e).parent().replaceWith(`<div class="item-display abbr">${t}</div>`)}update_total_incoming_rate(e){this.total_incoming_rate&&this.total_incoming_rate.set_value(e)}make_search_bar(){let e=this,t=e.events.get_frm().doc;this.$component.find(".search-field").html(""),this.$component.find(".pos-profile").html(""),this.$component.find(".total-incoming-rate").html(""),this.$component.find(".item-group-field").html(""),this.$component.find(".invoice-posting-date").html(""),frappe.db.get_single_value("POS Settings","custom_profile_lock").then(i=>{this.pos_profile_field=frappe.ui.form.make_control({df:{label:__("POS Profile"),fieldtype:"Link",options:"POS Profile",placeholder:__("POS Profile"),read_only:i,onchange:function(){e.reload_status&&e.pos_profile!==this.value&&frappe.pages.posnext.refresh(window.wrapper,window.onScan,this.value)}},parent:this.$component.find(".pos-profile"),render_input:!1}),this.pos_profile_field.set_value(e.pos_profile),this.pos_profile_field.refresh(),this.pos_profile_field.toggle_label(!1)}),this.search_field=frappe.ui.form.make_control({df:{label:__("Search"),fieldtype:"Data",placeholder:__("Search by serial number or barcode")},parent:this.$component.find(".search-field"),render_input:!0}),this.item_group_field=frappe.ui.form.make_control({df:{label:__("Item Group"),fieldtype:"Link",options:"Item Group",placeholder:__("Select item group"),onchange:function(){e.item_group=this.value,!e.item_group&&(e.item_group=e.parent_item_group),e.filter_items()},get_query:function(){return{query:"posnext.posnext.page.posnext.point_of_sale.item_group_query",filters:{pos_profile:t?t.pos_profile:""}}}},parent:this.$component.find(".item-group-field"),render_input:!0}),(this.custom_show_last_incoming_rate||this.custom_show_incoming_rate)&&(this.total_incoming_rate=frappe.ui.form.make_control({df:{label:__(""),fieldtype:"Currency",read_only:1,placeholder:__("Total Incoming Rate"),default:0},parent:this.$component.find(".total-incoming-rate"),render_input:!0})),e.custom_show_posting_date&&(this.invoice_posting_date=frappe.ui.form.make_control({df:{label:__("Posting Date"),fieldtype:"Date",onchange:function(){e.events.get_frm().doc.posting_date=this.value,e.events.get_frm().doc.set_posting_time=1}},parent:this.$component.find(".invoice-posting-date"),render_input:!0})),this.search_field.toggle_label(!1),this.item_group_field.toggle_label(!1),this.custom_show_last_incoming_rate&&this.total_incoming_rate.toggle_label(!1),e.custom_show_posting_date&&(this.invoice_posting_date.toggle_label(!1),this.invoice_posting_date.set_value(frappe.datetime.get_today())),this.attach_clear_btn()}attach_clear_btn(){this.search_field.$wrapper.find(".control-input").append(`<span class="link-btn" style="top: 2px;">
				<a class="btn-open no-decoration" title="${__("Clear")}">
					${frappe.utils.icon("close","sm")}
				</a>
			</span>`),this.$clear_search_btn=this.search_field.$wrapper.find(".link-btn"),this.$clear_search_btn.on("click","a",()=>{this.set_search_value(""),this.search_field.set_focus()})}set_search_value(e){$(this.search_field.$input[0]).val(e).trigger("input")}bind_events(){let e=this;window.onScan||frappe.require("https://cdn.jsdelivr.net/npm/onscan.js/onscan.min.js",function(){window.onScan=onScan,onScan.decodeKeyEvent=function(t){var i=this._getNormalizedKeyNum(t);switch(!0){case(i>=48&&i<=90):case(i>=106&&i<=111):case(i>=160&&i<=164||i==170):case(i>=186&&i<=194):case(i>=219&&i<=222):case i==32:if(t.key!==void 0&&t.key!=="")return t.key;var s=String.fromCharCode(i);switch(t.shiftKey){case!1:s=s.toLowerCase();break;case!0:s=s.toUpperCase();break}return s;case(i>=96&&i<=105):return 0+(i-96)}return""},onScan.attachTo(document,{onScan:t=>{this.search_field&&this.$component.is(":visible")&&(this.search_field.set_focus(),this.set_search_value(t),this.barcode_scanned=!0)}})}),this.$component.on("click",".item-wrapper",function(){console.log("OnClick Item Wrapper");let t=$(this),i=unescape(t.attr("data-item-code")),s=unescape(t.attr("data-batch-no")),o=unescape(t.attr("data-serial-no")),n=unescape(t.attr("data-uom")),a=unescape(t.attr("data-rate")),r=unescape(t.attr("data-valuation-rate")),c=t.attr("data-item-uoms"),m=t.attr("data-item-logical-rack");s=s==="undefined"?void 0:s,o=o==="undefined"?void 0:o,n=n==="undefined"?void 0:n,a=a==="undefined"?void 0:a,e.events.item_selected({field:"qty",value:"+1",item:{item_code:i,batch_no:s,serial_no:o,uom:n,rate:a,valuation_rate:r,custom_item_uoms:c,custom_logical_rack:m}})}),this.search_field.$input.on("input",t=>{clearTimeout(this.last_search),this.last_search=setTimeout(()=>{let i=t.target.value;this.filter_items({search_term:i})},300)})}attach_shortcuts(){let e=frappe.utils.is_mac()?"\u2318":"Ctrl";this.search_field.parent.attr("title",`${e}+I`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+i",action:()=>this.search_field.set_focus(),condition:()=>this.$component.is(":visible"),description:__("Focus on search input"),ignore_inputs:!0,page:cur_page.page.page}),this.item_group_field.parent.attr("title",`${e}+G`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+g",action:()=>this.item_group_field.set_focus(),condition:()=>this.$component.is(":visible"),description:__("Focus on Item Group filter"),ignore_inputs:!0,page:cur_page.page.page}),frappe.ui.keys.on("enter",()=>{!this.$component.is(":visible")||this.search_field.get_value()===""||(this.items.length==1?(this.$items_container.find(".item-wrapper").click(),frappe.utils.play_sound("submit"),this.set_search_value("")):this.items.length==0&&this.barcode_scanned&&(frappe.show_alert({message:__("No items found. Scan barcode again."),indicator:"orange"}),frappe.utils.play_sound("error"),this.barcode_scanned=!1,this.set_search_value("")))})}filter_items({search_term:e=""}={}){if(e&&(e=e.toLowerCase(),this.search_index=this.search_index||{},this.search_index[e])){let t=this.search_index[e];this.items=t,this.render_item_list(t),this.auto_add_item&&this.items.length==1;return}this.get_items({search_term:e}).then(({message:t})=>{let{items:i,serial_no:s,batch_no:o,barcode:n}=t;e&&!n&&(this.search_index[e]=i),this.items=i,this.render_item_list(i),this.auto_add_item&&this.items.length==1})}add_filtered_item_to_cart(){this.$items_container.find(".item-wrapper").click(),this.set_search_value("")}resize_selector(e){e?this.$component.find(".filter-section").css("grid-template-columns","repeat(1, minmax(0, 1fr))"):this.$component.find(".filter-section").css("grid-template-columns","repeat(12, minmax(0, 1fr))"),e?this.$component.find(".search-field").css("margin","var(--margin-sm) 0px"):this.$component.find(".search-field").css("margin","0px var(--margin-sm)"),e?this.$component.css("grid-column","span 2 / span 2"):this.$component.css("grid-column","span 6 / span 6"),e?this.$items_container.css("grid-template-columns","repeat(1, minmax(0, 1fr))"):this.$items_container.css("grid-template-columns","repeat(4, minmax(0, 1fr))")}toggle_component(e){this.set_search_value(""),this.$component.css("display",e?"flex":"none")}};frappe.provide("posnext.PointOfSale");posnext.PointOfSale.ItemCart=class{constructor({wrapper:e,events:t,settings:i}){this.wrapper=e,this.events=t,this.customer_info=void 0,this.hide_images=i.hide_images,this.allowed_customer_groups=i.customer_groups,this.allow_rate_change=i.allow_rate_change,this.allow_discount_change=i.allow_discount_change,this.show_held_button=i.custom_show_held_button,this.show_order_list_button=i.custom_show_order_list_button,this.mobile_number_based_customer=i.custom_mobile_number_based_customer,this.show_checkout_button=i.custom_show_checkout_button,this.custom_edit_rate=i.custom_edit_rate_and_uom,this.custom_use_discount_percentage=i.custom_use_discount_percentage,this.custom_use_discount_amount=i.custom_use_discount_amount,this.custom_use_additional_discount_amount=i.custom_use_additional_discount_amount,this.custom_show_incoming_rate=i.custom_show_incoming_rate&&i.custom_edit_rate_and_uom,this.custom_show_last_customer_rate=i.custom_show_last_customer_rate,this.custom_show_logical_rack_in_cart=i.custom_show_logical_rack_in_cart&&i.custom_edit_rate_and_uom,this.custom_show_uom_in_cart=i.custom_show_uom_in_cart&&i.custom_edit_rate_and_uom,this.settings=i,this.warehouse=i.warehouse,this.init_component()}init_component(){this.prepare_dom(),this.init_child_components(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.custom_edit_rate?this.wrapper.append('<section class="customer-cart-container customer-cart-container1 " style="grid-column: span 5 / span 5;" id="customer-cart-container2"></section>'):this.wrapper.append('<section class="customer-cart-container customer-cart-container1 " id="customer-cart-container2"></section>'),this.$component=this.wrapper.find(".customer-cart-container1")}init_child_components(){this.init_customer_selector(),this.init_cart_components()}init_customer_selector(){this.$component.append('<div class="customer-section"></div>'),this.$customer_section=this.$component.find(".customer-section"),this.make_customer_selector()}reset_customer_selector(){this.events.get_frm().set_value("customer",""),this.make_customer_selector(),this.customer_field.set_focus()}init_cart_components(){var e=`<div class="cart-container">
				<div class="abs-cart-container">
					<div class="cart-label">${__("Item Cart")}</div>
					<div class="cart-header">
						<div class="name-header" style="flex:3">${__("Item")}</div>
						<div class="qty-header" style="flex: 1">${__("Qty")}</div>
						`;this.custom_show_uom_in_cart&&(e+=`<div class="uom-header" style="flex: 1">${__("UOM")}</div>`),this.custom_edit_rate&&(e+=`<div class="rate-header" style="flex: 1">${__("Rate")}</div>`),this.custom_use_discount_percentage&&(e+=`<div class="discount-perc-header" style="flex: 1">${__("Disc%")}</div>`),this.custom_use_discount_amount&&(e+=`<div class="discount-amount-header" style="flex: 1">${__("Disc")}</div>`),this.custom_show_incoming_rate&&(e+=`<div class="incoming-rate-header" style="flex: 1">${__("Inc.Rate")}</div>`),this.custom_show_logical_rack_in_cart&&(e+=`<div class="incoming-rate-header" style="flex: 1">${__("Rack")}</div>`),this.custom_show_last_customer_rate&&(e+=`<div class="last-customer-rate-header" style="flex: 1">${__("LC Rate")}</div>`),e+=`<div class="rate-amount-header" style="flex: 1;text-align: left">${__("Amount")}</div>
					</div>
					<div class="cart-items-section" ></div>
					<div class="cart-totals-section"></div>
					<div class="numpad-section"></div>
				</div>
			</div>`,this.$component.append(e),this.$cart_container=this.$component.find(".cart-container"),this.make_cart_totals_section(),this.make_cart_items_section(),this.make_cart_numpad()}make_cart_items_section(){this.$cart_header=this.$component.find(".cart-header"),this.$cart_items_wrapper=this.$component.find(".cart-items-section"),this.make_no_items_placeholder()}make_no_items_placeholder(){this.$cart_header.css("display","none"),this.$cart_items_wrapper.html(`<div class="no-item-wrapper">${__("No items in cart")}</div>`)}get_discount_icon(){return`<svg class="discount-icon" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M19 15.6213C19 15.2235 19.158 14.842 19.4393 14.5607L20.9393 13.0607C21.5251 12.4749 21.5251 11.5251 20.9393 10.9393L19.4393 9.43934C19.158 9.15804 19 8.7765 19 8.37868V6.5C19 5.67157 18.3284 5 17.5 5H15.6213C15.2235 5 14.842 4.84196 14.5607 4.56066L13.0607 3.06066C12.4749 2.47487 11.5251 2.47487 10.9393 3.06066L9.43934 4.56066C9.15804 4.84196 8.7765 5 8.37868 5H6.5C5.67157 5 5 5.67157 5 6.5V8.37868C5 8.7765 4.84196 9.15804 4.56066 9.43934L3.06066 10.9393C2.47487 11.5251 2.47487 12.4749 3.06066 13.0607L4.56066 14.5607C4.84196 14.842 5 15.2235 5 15.6213V17.5C5 18.3284 5.67157 19 6.5 19H8.37868C8.7765 19 9.15804 19.158 9.43934 19.4393L10.9393 20.9393C11.5251 21.5251 12.4749 21.5251 13.0607 20.9393L14.5607 19.4393C14.842 19.158 15.2235 19 15.6213 19H17.5C18.3284 19 19 18.3284 19 17.5V15.6213Z" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
				<path d="M15 9L9 15" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
				<path d="M10.5 9.5C10.5 10.0523 10.0523 10.5 9.5 10.5C8.94772 10.5 8.5 10.0523 8.5 9.5C8.5 8.94772 8.94772 8.5 9.5 8.5C10.0523 8.5 10.5 8.94772 10.5 9.5Z" fill="white" stroke-linecap="round" stroke-linejoin="round"/>
				<path d="M15.5 14.5C15.5 15.0523 15.0523 15.5 14.5 15.5C13.9477 15.5 13.5 15.0523 13.5 14.5C13.5 13.9477 13.9477 13.5 14.5 13.5C15.0523 13.5 15.5 13.9477 15.5 14.5Z" fill="white" stroke-linecap="round" stroke-linejoin="round"/>
			</svg>`}make_cart_totals_section(){this.$totals_section=this.$component.find(".cart-totals-section"),this.$totals_section.append(`<div class="add-discount-wrapper">
				${this.get_discount_icon()} ${__("Add Discount")}
			</div>
			<div class="item-qty-total-container">
				<div class="item-qty-total-label">${__("Total Items")}</div>
				<div class="item-qty-total-value">0.00</div>
			</div>
			<div class="net-total-container">
				<div class="net-total-label">${__("Net Total")}</div>
				<div class="net-total-value">0.00</div>
			</div>
			<div class="taxes-container"></div>
			<div class="grand-total-container">
				<div>${__("Grand Total")}</div>
				<div>0.00</div>
			</div>
			<div style=" display: flex;justify-content: space-between;gap: 10px;">
				<div class="checkout-btn" style="
							padding: 10px;
							align-items: center;
							justify-content: center;
							color: white;
							border: none;
							border-radius: 5px;
							cursor: pointer;
							flex: 1; ">${__("Checkout")}</div>
				<div class="checkout-btn-held checkout-btn" style="
							padding: 10px;
							align-items: center;
							justify-content: center;
							color: white;
							border: none;
							border-radius: 5px;
							cursor: pointer;
							flex: 1;">${__("Held")}</div>
				<div class="checkout-btn-order checkout-btn" style="
				padding: 10px;
							align-items: center;
							justify-content: center;
							color: white;
							border: none;
							border-radius: 5px;
							cursor: pointer;
							flex: 1;">${__("Order List")}</div>
			</div>	
			<div class="edit-cart-btn">${__("Edit Cart")}</div>`),this.$add_discount_elem=this.$component.find(".add-discount-wrapper"),this.highlight_checkout_btn(!0)}make_cart_numpad(){this.$numpad_section=this.$component.find(".numpad-section"),this.number_pad=new posnext.PointOfSale.NumberPad({wrapper:this.$numpad_section,events:{numpad_event:this.on_numpad_event.bind(this)},cols:5,keys:[[1,2,3,"Quantity"],[4,5,6,"Discount"],[7,8,9,"Rate"],[".",0,"Delete","Remove"]],css_classes:[["","","","col-span-2"],["","","","col-span-2"],["","","","col-span-2"],["","","","col-span-2 remove-btn"]],fieldnames_map:{Quantity:"qty",Discount:"discount_percentage"}}),this.$numpad_section.prepend(`<div class="numpad-totals">
			<span class="numpad-item-qty-total"></span>
				<span class="numpad-net-total"></span>
				<span class="numpad-grand-total"></span>
			</div>`),this.$numpad_section.append(`<div class="numpad-btn checkout-btn" data-button-value="checkout">${__("Checkout")}</div>`)}bind_events(){let e=this;this.$customer_section.on("click",".reset-customer-btn",function(){e.reset_customer_selector()}),this.$customer_section.on("click",".close-details-btn",function(){e.toggle_customer_info(!1)}),this.$customer_section.on("click",".customer-display",function(t){if($(t.target).closest(".reset-customer-btn").length)return;let i=e.$cart_container.is(":visible");e.toggle_customer_info(i)}),e.custom_edit_rate||this.$cart_items_wrapper.on("click",".cart-item-wrapper",function(){let t=$(this);e.toggle_item_highlight(this),!e.$totals_section.find(".edit-cart-btn").is(":visible")||e.$totals_section.find(".edit-cart-btn").click();let s=unescape(t.attr("data-row-name"));e.events.cart_item_clicked({name:s}),this.numpad_value=""}),this.$component.on("click",".checkout-btn",async function(){if($(this).attr("style").indexOf("--blue-500")!=-1&&$(this).attr("class").indexOf("checkout-btn-held")===-1&&$(this).attr("class").indexOf("checkout-btn-order")===-1)if(!cur_frm.doc.customer&&e.mobile_number_based_customer){let n=new frappe.ui.Dialog({title:"Enter Mobile Number",fields:[{label:"Mobile Number",fieldname:"mobile_number",fieldtype:"Data",reqd:1},{label:"",fieldname:"mobile_number_numpad",fieldtype:"HTML",options:'<div class="mobile_number_numpad"></div>'}],size:"small",primary_action_label:"Continue",primary_action:function(a){a.mobile_number.length!==e.settings.custom_mobile_number_length&&frappe.throw("Mobile Number Length is "+e.settings.custom_mobile_number_length.toString()),frappe.call({method:"posnext.posnext.page.posnext.point_of_sale.create_customer",args:{customer:a.mobile_number},freeze:!0,freeze_message:"Creating Customer....",callback:async function(){let r=e.events.get_frm();frappe.dom.freeze(),frappe.model.set_value(r.doc.doctype,r.doc.name,"customer",a.mobile_number),r.script_manager.trigger("customer",r.doc.doctype,r.doc.name).then(()=>{frappe.run_serially([()=>e.fetch_customer_details(a.mobile_number),()=>e.events.customer_details_updated(e.customer_info),()=>e.update_customer_section(),()=>frappe.dom.unfreeze()])}),await e.events.checkout(),e.toggle_checkout_btn(!1),e.allow_discount_change&&e.$add_discount_elem.removeClass("d-none"),n.hide()}})}});var t=n.wrapper.find(".mobile_number_numpad");t.append(`
					<div class="custom-numpad">
						<style>
						.custom-numpad {
							display: grid;
							grid-template-columns: repeat(3, 1fr);
							gap: 10px;
							max-width: 350px;
							margin: 0 auto;
						}
						
						.numpad-button {
							padding: 15px;
							font-size: 18px;
							cursor: pointer;
							background-color: #f1f1f1;
							border: 1px solid #ccc;
							border-radius: 5px;
							text-align: center;
						}
						
						.numpad-button:hover {
							background-color: #ddd;
						}
						</style>
						<button class="numpad-button one">1</button>
						<button class="numpad-button two">2</button>
						<button class="numpad-button three">3</button>
						<button class="numpad-button four">4</button>
						<button class="numpad-button five">5</button>
						<button class="numpad-button six">6</button>
						<button class="numpad-button seven">7</button>
						<button class="numpad-button eight">8</button>
						<button class="numpad-button nine">9</button>
						<button class="numpad-button delete" style="color: red">x</button>
						<button class="numpad-button zero">0</button>
						<button class="numpad-button clear">C</button> <!-- Clear button -->
					</div>`),n.show();for(var i=n.wrapper.find(".custom-numpad"),s=["one","two","three","four","five","six","seven","eight","nine","zero","plus"],o=0;o<s.length;o+=1)i.on("click","."+s[o],function(){var a=n.get_value("mobile_number");n.set_value("mobile_number",a+$(this)[0].innerHTML.toString())});i.on("click",".clear",function(){n.set_value("mobile_number","")}),i.on("click",".delete",function(){var a=n.get_value("mobile_number");n.set_value("mobile_number",a.slice(0,-1))})}else!cur_frm.doc.customer&&!e.mobile_number_based_customer&&frappe.throw("Please Select a customer and add items first"),await e.events.checkout(),e.toggle_checkout_btn(!1),e.allow_discount_change&&e.$add_discount_elem.removeClass("d-none")}),this.$component.on("click",".checkout-btn-held",function(){if($(this).attr("style").indexOf("--blue-500")!=-1)if(!cur_frm.doc.customer&&e.mobile_number_based_customer){let n=new frappe.ui.Dialog({title:"Enter Mobile Number",fields:[{label:"Mobile Number",fieldname:"mobile_number",fieldtype:"Data",reqd:1},{label:"",fieldname:"mobile_number_numpad",fieldtype:"HTML",options:'<div class="mobile_number_numpad"></div>'}],size:"small",primary_action_label:"Continue",primary_action:function(a){a.mobile_number.length!==e.settings.custom_mobile_number_length&&frappe.throw("Mobile Number Length is "+e.settings.custom_mobile_number_length.toString()),frappe.call({method:"posnext.posnext.page.posnext.point_of_sale.create_customer",args:{customer:a.mobile_number},freeze:!0,freeze_message:"Creating Customer....",callback:async function(){let r=e.events.get_frm();frappe.dom.freeze(),frappe.model.set_value(r.doc.doctype,r.doc.name,"customer",a.mobile_number),r.script_manager.trigger("customer",r.doc.doctype,r.doc.name).then(()=>{frappe.run_serially([()=>e.fetch_customer_details(a.mobile_number),()=>e.events.customer_details_updated(e.customer_info),()=>e.update_customer_section(),()=>frappe.dom.unfreeze()])}),e.events.save_draft_invoice(),n.hide()}})}});var t=n.wrapper.find(".mobile_number_numpad");t.append(`
					<div class="custom-numpad">
						<style>
						.custom-numpad {
							display: grid;
							grid-template-columns: repeat(3, 1fr);
							gap: 10px;
							max-width: 350px;
							margin: 0 auto;
						}
						
						.numpad-button {
							padding: 15px;
							font-size: 18px;
							cursor: pointer;
							background-color: #f1f1f1;
							border: 1px solid #ccc;
							border-radius: 5px;
							text-align: center;
						}
						
						.numpad-button:hover {
							background-color: #ddd;
						}
						</style>
						<button class="numpad-button one">1</button>
						<button class="numpad-button two">2</button>
						<button class="numpad-button three">3</button>
						<button class="numpad-button four">4</button>
						<button class="numpad-button five">5</button>
						<button class="numpad-button six">6</button>
						<button class="numpad-button seven">7</button>
						<button class="numpad-button eight">8</button>
						<button class="numpad-button nine">9</button>
						<button class="numpad-button delete" style="color: red">x</button>
						<button class="numpad-button zero">0</button>
						<button class="numpad-button clear">C</button> <!-- Clear button -->
					</div>`),n.show();for(var i=n.wrapper.find(".custom-numpad"),s=["one","two","three","four","five","six","seven","eight","nine","zero","plus"],o=0;o<s.length;o+=1)i.on("click","."+s[o],function(){var a=n.get_value("mobile_number");n.set_value("mobile_number",a+$(this)[0].innerHTML.toString())});i.on("click",".clear",function(){n.set_value("mobile_number","")}),i.on("click",".delete",function(){var a=n.get_value("mobile_number");n.set_value("mobile_number",a.slice(0,-1))})}else e.events.save_draft_invoice()}),this.$component.on("click",".checkout-btn-order",()=>{this.events.toggle_recent_order()}),this.$totals_section.on("click",".edit-cart-btn",()=>{this.events.edit_cart(),this.toggle_checkout_btn(!0)}),this.$component.on("click",".add-discount-wrapper",()=>{let t=this.$add_discount_elem.find(".edit-discount-btn").length;(!this.discount_field||t)&&this.show_discount_control()}),frappe.ui.form.on("Sales Invoice","paid_amount",t=>{this.update_totals_section(t)})}attach_shortcuts(){for(let t of this.number_pad.keys)for(let i of t){if(typeof i!="string")continue;let s=`ctrl+${frappe.scrub(String(i))[0]}`;i==="Delete"&&(s="ctrl+backspace"),i==="Remove"&&(s="shift+ctrl+backspace"),i==="."&&(s="ctrl+>");let o=this.number_pad.fieldnames[i]?this.number_pad.fieldnames[i]:typeof i=="string"?frappe.scrub(i):i,n=s.split("+").map(frappe.utils.to_title_case).join("+");n=frappe.utils.is_mac()?n.replace("Ctrl","\u2318"):n,this.$numpad_section.find(`.numpad-btn[data-button-value="${o}"]`).attr("title",n),frappe.ui.keys.on(`${s}`,()=>{this.$component.is(":visible")&&this.item_is_selected&&this.$numpad_section.is(":visible")&&this.$numpad_section.find(`.numpad-btn[data-button-value="${o}"]`).click()})}let e=frappe.utils.is_mac()?"\u2318":"Ctrl";this.$component.find(".checkout-btn").attr("title",`${e}+Enter`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+enter",action:()=>this.$component.find(".checkout-btn").click(),condition:()=>this.$component.is(":visible")&&!this.$totals_section.find(".edit-cart-btn").is(":visible"),description:__("Checkout Order / Submit Order / New Order"),ignore_inputs:!0,page:cur_page.page.page}),this.$component.find(".edit-cart-btn").attr("title",`${e}+E`),frappe.ui.keys.on("ctrl+e",()=>{let t=this.$component.is(":visible"),i=!this.$totals_section.find(".checkout-btn").is("visible");t&&i&&this.$component.find(".edit-cart-btn").click()}),this.$component.find(".add-discount-wrapper").attr("title",`${e}+D`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+d",action:()=>this.$component.find(".add-discount-wrapper").click(),condition:()=>this.$add_discount_elem.is(":visible"),description:__("Add Order Discount"),ignore_inputs:!0,page:cur_page.page.page}),frappe.ui.keys.on("escape",()=>{this.$component.is(":visible")&&this.discount_field&&this.discount_field.parent.is(":visible")&&this.discount_field.set_value(0)})}toggle_item_highlight(e){let t=$(e),i=t.attr("style")=="background-color:var(--gray-50);";!e||i?(this.item_is_selected=!1,this.$cart_container.find(".cart-item-wrapper").css("background-color","")):(t.css("background-color","var(--control-bg)"),this.item_is_selected=!0,this.$cart_container.find(".cart-item-wrapper").not(e).css("background-color",""))}make_customer_selector(){this.$customer_section.html(`
			<div class="customer-field"></div>
		`);let e=this,t={query:"posnext.controllers.queries.customer_query"},i=this.allowed_customer_groups||[];i.length&&(t.filters={customer_group:["in",i]}),this.customer_field=frappe.ui.form.make_control({df:{label:__("Customer"),fieldtype:"Link",options:"Customer",placeholder:__("Search by customer name, phone, email."),read_only:this.mobile_number_based_customer,get_query:()=>t,onchange:function(){if(this.value){let s=e.events.get_frm();frappe.dom.freeze(),frappe.model.set_value(s.doc.doctype,s.doc.name,"customer",this.value),s.script_manager.trigger("customer",s.doc.doctype,s.doc.name).then(()=>{frappe.run_serially([()=>e.fetch_customer_details(this.value),()=>e.events.customer_details_updated(e.customer_info),()=>e.update_customer_section(),()=>e.update_totals_section(),()=>frappe.dom.unfreeze()])})}}},parent:this.$customer_section.find(".customer-field"),render_input:!0}),this.customer_field.toggle_label(!1)}fetch_customer_details(e){return e?new Promise(t=>{frappe.db.get_value("Customer",e,["email_id","mobile_no","image","loyalty_program"]).then(({message:i})=>{let{loyalty_program:s}=i;s?frappe.call({method:"erpnext.accounts.doctype.loyalty_program.loyalty_program.get_loyalty_program_details_with_points",args:{customer:e,loyalty_program:s,silent:!0},callback:o=>{let{loyalty_points:n,conversion_factor:a}=o.message;o.exc||(this.customer_info=v(u({},i),{customer:e,loyalty_points:n,conversion_factor:a}),t())}}):(this.customer_info=v(u({},i),{customer:e}),t())})}):new Promise(t=>{this.customer_info={},t()})}show_discount_control(){this.$add_discount_elem.css({padding:"0px",border:"none"}),this.$add_discount_elem.html('<div class="add-discount-field"></div>');let e=this,t=e.events.get_frm(),i=t.doc.additional_discount_percentage;this.discount_field=null,e.custom_use_additional_discount_amount?this.discount_field=frappe.ui.form.make_control({df:{label:__("Discount"),fieldtype:"Data",placeholder:i||__("Enter discount amount."),input_class:"input-xs",onchange:function(){setTimeout(()=>{flt(this.value)!=0?(frappe.model.set_value(t.doc.doctype,t.doc.name,"discount_amount",flt(this.value)),e.hide_discount_control(this.value)):(frappe.model.set_value(t.doc.doctype,t.doc.name,"discount_amount",0),e.$add_discount_elem.css({border:"1px dashed var(--gray-500)",padding:"var(--padding-sm) var(--padding-md)"}),e.$add_discount_elem.html(`${e.get_discount_icon()} ${__("Add Discount")}`),e.discount_field=void 0)},3e3)}},parent:this.$add_discount_elem.find(".add-discount-field"),render_input:!0}):this.discount_field=frappe.ui.form.make_control({df:{label:__("Discount"),fieldtype:"Data",placeholder:i?i+"%":__("Enter discount percentage."),input_class:"input-xs",onchange:function(){setTimeout(()=>{flt(this.value)!=0?(frappe.model.set_value(t.doc.doctype,t.doc.name,"additional_discount_percentage",flt(this.value)),e.hide_discount_control(this.value)):(frappe.model.set_value(t.doc.doctype,t.doc.name,"additional_discount_percentage",0),e.$add_discount_elem.css({border:"1px dashed var(--gray-500)",padding:"var(--padding-sm) var(--padding-md)"}),e.$add_discount_elem.html(`${e.get_discount_icon()} ${__("Add Discount")}`),e.discount_field=void 0)},3e3)}},parent:this.$add_discount_elem.find(".add-discount-field"),render_input:!0}),this.discount_field.toggle_label(!1),this.discount_field.set_focus()}hide_discount_control(e){e?(this.$add_discount_elem.css({border:"1px dashed var(--dark-green-500)",padding:"var(--padding-sm) var(--padding-md)"}),this.custom_use_additional_discount_amount?this.$add_discount_elem.html(`<div class="edit-discount-btn">
						${this.get_discount_icon()} ${__("Additional")}&nbsp;${String(e).bold()}&nbsp;${this.events.get_frm().doc.currency} ${__("discount applied")}
					</div>`):this.$add_discount_elem.html(`<div class="edit-discount-btn">
						${this.get_discount_icon()} ${__("Additional")}&nbsp;${String(e).bold()}% ${__("discount applied")}
					</div>`)):(this.$add_discount_elem.css({padding:"0px",border:"none"}),this.$add_discount_elem.html('<div class="add-discount-field"></div>'))}update_customer_section(){let e=this,{customer:t,email_id:i="",mobile_no:s="",image:o}=this.customer_info||{};t?(this.$customer_section.html(`<div class="customer-details">
					<div class="customer-display">
						${this.get_customer_image()}
						<div class="customer-name-desc">
							<div class="customer-name">${t}</div>
							${n()}
						</div>
						<div class="reset-customer-btn" data-customer="${escape(t)}">
							<svg width="32" height="32" viewBox="0 0 14 14" fill="none">
								<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>
							</svg>
						</div>
					</div>
				</div>`),this.mobile_number_based_customer?this.$customer_section.find(".reset-customer-btn").css("display","none"):this.$customer_section.find(".reset-customer-btn").css("display","flex")):this.reset_customer_selector();function n(){return!i&&!s?`<div class="customer-desc">${__("Click to add email / phone")}</div>`:i&&!s?`<div class="customer-desc">${i}</div>`:s&&!i?`<div class="customer-desc">${s}</div>`:`<div class="customer-desc">${i} - ${s}</div>`}}get_customer_image(){let{customer:e,image:t}=this.customer_info||{};return t?`<div class="customer-image"><img src="${t}" alt="${t}""></div>`:`<div class="customer-image customer-abbr">${frappe.get_abbr(e)}</div>`}update_totals_section(e){e||(e=this.events.get_frm()),this.render_net_total(e.doc.net_total),this.render_total_item_qty(e.doc.items);let t=cint(frappe.sys_defaults.disable_rounded_total)?e.doc.grand_total:e.doc.rounded_total;this.render_grand_total(t),this.render_taxes(e.doc.taxes)}render_net_total(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".net-total-container").html(`<div>${__("Net Total")}</div><div>${format_currency(e,t)}</div>`),this.$numpad_section.find(".numpad-net-total").html(`<div>${__("Net Total")}: <span>${format_currency(e,t)}</span></div>`)}render_total_item_qty(e){var t=0;e.map(i=>{t=t+i.qty}),this.$totals_section.find(".item-qty-total-container").html(`<div>${__("Total Quantity")}</div><div>${t}</div>`),this.$numpad_section.find(".numpad-item-qty-total").html(`<div>${__("Total Quantity")}: <span>${t}</span></div>`)}render_grand_total(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".grand-total-container").html(`<div>${__("Grand Total")}</div><div>${format_currency(e,t)}</div>`),this.$numpad_section.find(".numpad-grand-total").html(`<div>${__("Grand Total")}: <span>${format_currency(e,t)}</span></div>`)}render_taxes(e){if(e&&e.length){let t=this.events.get_frm().doc.currency,i=e.map(s=>s.tax_amount_after_discount_amount==0?void 0:`<div class="tax-row">
					<div class="tax-label">${/[0-9]+/.test(s.description)?s.description:s.rate!=0?`${s.description} @ ${s.rate}%`:s.description}</div>
					<div class="tax-value">${format_currency(s.tax_amount_after_discount_amount,t)}</div>
				</div>`).join("");this.$totals_section.find(".taxes-container").css("display","flex").html(i)}else this.$totals_section.find(".taxes-container").css("display","none").html("")}get_cart_item({name:e}){let t=`.cart-item-wrapper[data-row-name="${escape(e)}"]`;return this.$cart_items_wrapper.find(t)}get_item_from_frm(e){return this.events.get_frm().doc.items.find(i=>i.name==e.name)}update_item_html(e,t){let i=this.get_cart_item(e);if(t)i&&i.next().remove()&&i.remove();else{let o=this.get_item_from_frm(e);this.render_cart_item(o,i)}let s=this.$cart_items_wrapper.find(".cart-item-wrapper").length;this.highlight_checkout_btn(!0),this.update_empty_cart_section(s)}render_cart_item(e,t){let i=this.events.get_frm().doc.currency,s=this;t.length||(this.$cart_items_wrapper.append(`<div class="cart-item-wrapper" data-row-name="${escape(e.name)}"></div>
				<div class="seperator"></div>`),t=this.get_cart_item(e));var o=`${d()}`;if(s.custom_use_discount_percentage&&!s.custom_use_discount_amount&&(o+='<div class="item-name-desc" style="flex: 2.8">'),s.custom_use_discount_amount&&!s.custom_use_discount_percentage&&(o+='<div class="item-name-desc" style="flex: 2.8">'),s.custom_use_discount_amount&&s.custom_use_discount_percentage&&(o+='<div class="item-name-desc" style="flex: 2.5">'),!s.custom_use_discount_amount&&!s.custom_use_discount_percentage&&(o+='<div class="item-name-desc" style="flex: 3.5">'),o+=`<div class="item-name">
					${e.item_name}
				</div>
				${l()}
			</div>
			${m()}`,t.html(o),s.custom_edit_rate){this[e.item_code+"_qty"]=frappe.ui.form.make_control({df:{fieldname:"qty",fieldtype:"Float",onchange:function(){s.events.form_updated(e,"qty",this.value)}},parent:t.find(".item-qty"),render_input:!0});var n=[];e.custom_item_uoms?n=e.custom_item_uoms.split(","):e.uom&&(n=[e.uom]),s.custom_show_uom_in_cart&&(this[e.item_code+"_uom"]=frappe.ui.form.make_control({df:{fieldname:"uom",fieldtype:"Select",onchange:function(){s.events.form_updated(e,"uom",this.value)}},parent:t.find(".item-uom"),render_input:!0})),this[e.item_code+"_rate"]=frappe.ui.form.make_control({df:{fieldname:"rate",fieldtype:"Float",read_only:!s.allow_rate_change,onchange:function(){s.events.form_updated(e,"rate",this.value)}},parent:t.find(".item-rate"),render_input:!0}),s.custom_use_discount_percentage&&(this[e.item_code+"_discount"]=frappe.ui.form.make_control({df:{fieldname:"discount",fieldtype:"Float",onchange:function(){s.events.form_updated(e,"discount_percentage",this.value)}},parent:t.find(".item-rate-discount"),render_input:!0})),s.custom_use_discount_amount&&(this[e.item_code+"_discount_amount"]=frappe.ui.form.make_control({df:{fieldname:"discount_amount",fieldtype:"Currency",onchange:function(){s.events.form_updated(e,"discount_amount",this.value)}},parent:t.find(".item-rate-discount-amount"),render_input:!0})),this.custom_show_incoming_rate&&(this[e.item_code+"_incoming_rate"]=frappe.ui.form.make_control({df:{fieldname:"incoming_rate",fieldtype:"Float",read_only:1},parent:t.find(".item-incoming-rate"),render_input:!0})),this.custom_show_logical_rack_in_cart&&(this[e.item_code+"_logical_rack"]=frappe.ui.form.make_control({df:{fieldname:"logical_rack",fieldtype:"Data",read_only:1},parent:t.find(".item-logical-rack"),render_input:!0})),this.custom_show_last_customer_rate&&(this[e.item_code+"_last_customer_rate"]=frappe.ui.form.make_control({df:{fieldname:"last_customer_rate",fieldtype:"Float",read_only:1},parent:t.find(".item-last-customer-rate"),render_input:!0})),this[e.item_code+"_amount"]=frappe.ui.form.make_control({df:{fieldname:"amount",fieldtype:"Float",read_only:1},parent:t.find(".item-rate-amount"),render_input:!0});var a='<svg width="16px" height="16px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ff0000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M10 11V17" stroke="#ff0000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M14 11V17" stroke="#ff0000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M4 7H20" stroke="#ff0000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M6 7H12H18V18C18 19.6569 16.6569 21 15 21H9C7.34315 21 6 19.6569 6 18V7Z" stroke="#ff0000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5V7H9V5Z" stroke="#ff0000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>',r=frappe.ui.form.make_control({df:{fieldname:"remove",fieldtype:"Button",label:a},parent:t.find(".remove-button"),render_input:!0});r.refresh(),$(r.$input).on("click",function(){s.events.remove_item_from_cart(e),s.prev_action=void 0,s.toggle_item_highlight(),s.events.numpad_event(void 0,"remove")}),this[e.item_code+"_qty"].set_value(e.qty),s.custom_show_uom_in_cart&&(this[e.item_code+"_uom"].df.options=n,this[e.item_code+"_uom"].set_value(e.uom),this[e.item_code+"_uom"].refresh()),this[e.item_code+"_amount"].set_value(e.amount),this[e.item_code+"_rate"].set_value(e.rate),s.custom_use_discount_percentage&&this[e.item_code+"_discount"].set_value(e.discount_percentage),s.custom_use_discount_amount&&this[e.item_code+"_discount_amount"].set_value(e.discount_amount),s.custom_show_incoming_rate&&this[e.item_code+"_incoming_rate"].set_value(e.custom_valuation_rate),s.custom_show_logical_rack_in_cart&&this[e.item_code+"_logical_rack"].set_value(e.custom_logical_rack),s.custom_show_last_customer_rate&&frappe.xcall("posnext.posnext.page.posnext.point_of_sale.get_lcr",{customer:s.customer_info.customer,item_code:e.item_code}).then(_=>{this[e.item_code+"_last_customer_rate"].set_value(_)}),s.custom_show_uom_in_cart&&frappe.xcall("posnext.posnext.page.posnext.point_of_sale.get_uoms",{item_code:e.item_code}).then(_=>{this[e.item_code+"_uom"].df.options=_,this[e.item_code+"_uom"].refresh()})}c();function c(){let _=Array.from(s.$cart_items_wrapper.find(".item-rate-amount"));s.$cart_header.find(".rate-amount-header").css("width",""),s.$cart_items_wrapper.find(".item-rate-amount").css("width","");let p=_.reduce((g,y)=>($(y).width()>g&&(g=$(y).width()),g),0);p+=1,p==1&&(p=""),s.$cart_header.find(".rate-amount-header").css("width",p),s.$cart_items_wrapper.find(".item-rate-amount").css("width",p)}function m(){if(s.custom_edit_rate)if(e.rate&&e.amount&&e.rate!==e.amount){var _=`
                        <div class="item-qty-rate" style="flex: 6">
                        <div class="item-qty" style="flex: 1"></div>`;return s.custom_show_uom_in_cart&&(_+='<div class="item-uom" style="flex: 1;text-align: left"></div>'),_+='<div class="item-rate" style="flex: 1;"></div>',s.custom_use_discount_percentage&&(_+='<div class="item-rate-discount" style="flex: 1;text-align: left"></div>'),s.custom_use_discount_amount&&(_+='<div class="item-rate-discount-amount" style="flex: 1;text-align: left"></div>'),s.custom_show_incoming_rate&&(_+='<div class="item-incoming-rate" style="flex: 1"></div>'),s.custom_show_logical_rack_in_cart&&(_+='<div class="item-logical-rack" style="flex: 1"></div>'),s.custom_show_last_customer_rate&&(_+='<div class="item-last-customer-rate" style="flex: 1"></div>'),_+=`<div class="item-rate-amount" style="flex: 1"></div>
							<div class="remove-button" style="margin-top:15px;display: flex;justify-content: center;align-items: center;"></div>
                        </div>`,_}else{var _=`
                        <div class="item-qty-rate" style="flex: 6">
                        <div class="item-qty" style="flex: 1"></div>`;return s.custom_show_uom_in_cart&&(_+='<div class="item-uom" style="flex: 1;text-align: left"></div>'),_+='<div class="item-rate" style="flex: 1;"></div>',s.custom_use_discount_percentage&&(_+='<div class="item-rate-discount" style="flex: 1;text-align: left"></div>'),s.custom_use_discount_amount&&(_+='<div class="item-rate-discount-amount" style="flex: 1;text-align: left"></div>'),s.custom_show_incoming_rate&&(_+='<div class="item-incoming-rate" style="flex: 1"></div>'),s.custom_show_logical_rack_in_cart&&(_+='<div class="item-logical-rack" style="flex: 1"></div>'),s.custom_show_last_customer_rate&&(_+='<div class="item-last-customer-rate" style="flex: 1"></div>'),_+=`<div class="item-rate-amount" style="flex: 1"></div>
                            <div class="remove-button" style="margin-top:15px;display: flex;justify-content: center;align-items: center;"></div>
                        </div>`,_}else return e.rate&&e.amount&&e.rate!==e.amount?`
                        <div class="item-qty-rate" style="flex: 4" > 
                            <div class="item-qty" style="flex: 1"><span>${e.qty||0}</span></div>
                            <div class="item-qty" style="flex: 1"><span> ${e.uom}</span></div>
                            <div class="item-rate-amount" style="flex: 1">
                                <div class="item-rate">${parseFloat(e.amount).toFixed(2)}</div>
                                <div class="item-amount">${parseFloat(e.rate).toFixed(2)}</div>
                            </div>
                        </div>`:`
                        <div class="item-qty-rate" style="flex: 4" >
                            <div class="item-qty" style="flex: 1" ><span>${e.qty||0}</span></div>
                            <div class="item-qty" style="flex: 1"><span> ${e.uom}</span></div>
                            <div class="item-rate-amount" style="flex: 1">
                                <div class="item-rate">${parseFloat(e.rate).toFixed(2)}</div>
                            </div>
                        </div>`}function l(){if(e.description){if(e.description.indexOf("<div>")!=-1)try{e.description=$(e.description).text()}catch(_){e.description=e.description.replace(/<div>/g," ").replace(/<\/div>/g," ").replace(/ +/g," ")}return e.description=frappe.ellipsis(e.description,45),`<div class="item-desc">${e.description}</div>`}return""}function d(){let{image:_,item_name:p}=e;return!s.hide_images&&_?`
					<div class="item-image">
						<img
							onerror="cur_pos.cart.handle_broken_image(this)"
							src="${_}" alt="${frappe.get_abbr(p)}"">
					</div>`:`<div class="item-image item-abbr">${frappe.get_abbr(p)}</div>`}}handle_broken_image(e){let t=$(e).attr("alt");$(e).parent().replaceWith(`<div class="item-image item-abbr">${t}</div>`)}update_selector_value_in_cart_item(e,t,i){this.get_cart_item(i).attr(`data-${e}`,escape(t))}toggle_checkout_btn(e){e?(this.show_checkout_button?this.$totals_section.find(".checkout-btn").css("display","flex"):this.$totals_section.find(".checkout-btn").css("display","none"),this.show_held_button?this.$totals_section.find(".checkout-btn-held").css("display","flex"):this.$totals_section.find(".checkout-btn-held").css("display","none"),this.show_order_list_button?this.$totals_section.find(".checkout-btn-order").css("display","flex"):this.$totals_section.find(".checkout-btn-order").css("display","none"),this.$totals_section.find(".edit-cart-btn").css("display","none")):(this.$totals_section.find(".checkout-btn").css("display","none"),this.$totals_section.find(".checkout-btn-held").css("display","none"),this.$totals_section.find(".checkout-btn-held").css("display","none"),this.$totals_section.find(".checkout-btn-order").css("display","none"),this.$totals_section.find(".edit-cart-btn").css("display","flex"))}highlight_checkout_btn(e){e?(this.$add_discount_elem.css("display","flex"),this.$cart_container.find(".checkout-btn").css({"background-color":"var(--blue-500)"}),this.show_held_button?this.$cart_container.find(".checkout-btn-held").css({"background-color":"var(--blue-500)"}):this.$cart_container.find(".checkout-btn-held").css({"background-color":"var(--blue-200)"}),this.show_order_list_button?this.$cart_container.find(".checkout-btn-order").css({"background-color":"var(--blue-500)"}):this.$cart_container.find(".checkout-btn-order").css({"background-color":"var(--blue-500)"})):(this.$add_discount_elem.css("display","none"),this.$cart_container.find(".checkout-btn").css({"background-color":"var(--blue-200)"}),this.$cart_container.find(".checkout-btn-held").css({"background-color":"var(--blue-200)"}),this.$cart_container.find(".checkout-btn-order").css({"background-color":"var(--blue-500)"}))}update_empty_cart_section(e){let t=this.$cart_items_wrapper.find(".no-item-wrapper");e>0&&t&&t.remove()&&this.$cart_header.css("display","flex"),e===0&&!t.length&&this.make_no_items_placeholder()}on_numpad_event(e){let t=e.attr("data-button-value"),i=["qty","discount_percentage","rate"].includes(t),s=i?t=="rate"&&this.allow_rate_change||t=="discount_percentage"&&this.allow_discount_change||t=="qty":!0,o=this.prev_action===t,n=!this.prev_action,a=this.prev_action&&this.prev_action!=t;if(i){if(!s){let c=t=="rate"?"Rate".bold():"Discount".bold(),m=__("Editing {0} is not allowed as per POS Profile settings",[c]);frappe.show_alert({indicator:"red",message:m}),frappe.utils.play_sound("error");return}n||a?this.prev_action=t:o&&(this.prev_action=void 0),this.numpad_value=""}else if(t==="checkout"){this.prev_action=void 0,this.toggle_item_highlight(),this.events.numpad_event(void 0,t);return}else if(t==="remove"){this.prev_action=void 0,this.toggle_item_highlight(),this.events.numpad_event(void 0,t);return}else this.numpad_value=t==="delete"?this.numpad_value.slice(0,-1):this.numpad_value+t,this.numpad_value=this.numpad_value||0;if(!i&&n){frappe.show_alert({indicator:"red",message:__("Please select a field to edit from numpad")}),frappe.utils.play_sound("error");return}flt(this.numpad_value)>100&&this.prev_action==="discount_percentage"&&(frappe.show_alert({message:__("Discount cannot be greater than 100%"),indicator:"orange"}),frappe.utils.play_sound("error"),this.numpad_value=t),this.highlight_numpad_btn(e,t),this.events.numpad_event(this.numpad_value,this.prev_action)}highlight_numpad_btn(e,t){let i=e.hasClass("highlighted-numpad-btn"),s=["qty","discount_percentage","rate","done"].includes(t);i||e.addClass("highlighted-numpad-btn"),this.prev_action===t&&i&&e.removeClass("highlighted-numpad-btn"),this.prev_action&&this.prev_action!==t&&s&&$(`[data-button-value='${this.prev_action}']`).removeClass("highlighted-numpad-btn"),(!s||t==="done")&&setTimeout(()=>{e.removeClass("highlighted-numpad-btn")},200)}toggle_numpad(e){e?(this.$totals_section.css("display","none"),this.$numpad_section.css("display","flex")):(this.$totals_section.css("display","flex"),this.$numpad_section.css("display","none")),this.reset_numpad()}reset_numpad(){this.numpad_value="",this.prev_action=void 0,this.$numpad_section.find(".highlighted-numpad-btn").removeClass("highlighted-numpad-btn")}toggle_numpad_field_edit(e){["qty","discount_percentage","rate"].includes(e)&&this.$numpad_section.find(`[data-button-value="${e}"]`).click()}toggle_customer_info(e){if(e){let{customer:t}=this.customer_info||{};this.$cart_container.css("display","none"),this.$customer_section.css({height:"100%","padding-top":"0px"}),this.$customer_section.find(".customer-details").html(`<div class="header">

					<div class="label">Contact Details</div>
					<div class="close-details-btn">
						<svg width="32" height="32" viewBox="0 0 14 14" fill="none">
							<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>
						</svg>
					</div>
				</div>
				<div class="customer-display">
					${this.get_customer_image()}
					<div class="customer-name-desc">
						<div class="customer-name">${t}</div>
						<div class="customer-desc"></div>
					</div>
				</div>
				<div class="customer-fields-container">
					<div class="email_id-field"></div>
					<div class="mobile_no-field"></div>
					<div class="loyalty_program-field"></div>
					<div class="loyalty_points-field"></div>
				</div>
				<div class="transactions-label">Recent Transactions</div>`),this.$customer_section.append('<div class="customer-transactions"></div>'),this.mobile_number_based_customer?(this.$customer_section.find(".mobile_no-field").css("display","none"),this.$customer_section.find(".close-details-btn").css("display","none")):(this.$customer_section.find(".mobile_no-field").css("display","flex"),this.$customer_section.find(".close-details-btn").css("display","flex")),this.render_customer_fields(),this.fetch_customer_transactions()}else this.$cart_container.css("display","flex"),this.$customer_section.css({height:"","padding-top":""}),this.update_customer_section()}render_customer_fields(){let e=this.$customer_section.find(".customer-fields-container"),t=[{fieldname:"email_id",label:__("Email"),fieldtype:"Data",options:"email",placeholder:__("Enter customer's email")},{fieldname:"mobile_no",label:__("Phone Number"),fieldtype:"Data",placeholder:__("Enter customer's phone number")},{fieldname:"loyalty_program",label:__("Loyalty Program"),fieldtype:"Link",options:"Loyalty Program",placeholder:__("Select Loyalty Program")},{fieldname:"loyalty_points",label:__("Loyalty Points"),fieldtype:"Data",read_only:1}],i=this;t.forEach(o=>{this[`customer_${o.fieldname}_field`]=frappe.ui.form.make_control({df:v(u({},o),{onchange:s}),parent:e.find(`.${o.fieldname}-field`),render_input:!0}),this[`customer_${o.fieldname}_field`].set_value(this.customer_info[o.fieldname])});function s(){let o=i.customer_info[this.df.fieldname],n=i.customer_info.customer;this.value&&o!=this.value&&this.df.fieldname!="loyalty_points"&&frappe.call({method:"posnext.posnext.page.posnext.point_of_sale.set_customer_info",args:{fieldname:this.df.fieldname,customer:n,value:this.value},callback:a=>{a.exc||(i.customer_info[this.df.fieldname]=this.value,frappe.show_alert({message:__("Customer contact updated successfully."),indicator:"green"}),frappe.utils.play_sound("submit"))}})}}fetch_customer_transactions(){frappe.db.get_list("Sales Invoice",{filters:{customer:this.customer_info.customer,docstatus:1},fields:["name","grand_total","status","posting_date","posting_time","currency"],limit:20}).then(e=>{let t=this.$customer_section.find(".customer-transactions");if(!e.length){t.html('<div class="no-transactions-placeholder">No recent transactions found</div>');return}let i=moment(e[0].posting_date+" "+e[0].posting_time).fromNow();this.$customer_section.find(".customer-desc").html(`Last transacted ${i}`),e.forEach(s=>{let o=moment(s.posting_date+" "+s.posting_time).format("Do MMMM, h:mma"),n={Paid:"green",Draft:"red",Return:"gray",Consolidated:"blue"};t.append(`<div class="invoice-wrapper" data-invoice-name="${escape(s.name)}">
						<div class="invoice-name-date">
							<div class="invoice-name">${s.name}</div>
							<div class="invoice-date">${o}</div>
						</div>
						<div class="invoice-total-status">
							<div class="invoice-total">
								${format_currency(s.grand_total,s.currency,0)||0}
							</div>
							<div class="invoice-status">
								<span class="indicator-pill whitespace-nowrap ${n[s.status]}">
									<span>${s.status}</span>
								</span>
							</div>
						</div>
					</div>
					<div class="seperator"></div>`)})})}attach_refresh_field_event(e){$(e.wrapper).off("refresh-fields"),$(e.wrapper).on("refresh-fields",()=>{e.doc.items.length&&(this.$cart_items_wrapper.html(""),e.doc.items.forEach(t=>{this.update_item_html(t)})),this.update_totals_section(e)})}load_invoice(){let e=this.events.get_frm();this.attach_refresh_field_event(e),this.fetch_customer_details(e.doc.customer).then(()=>{this.events.customer_details_updated(this.customer_info),this.update_customer_section()}),this.$cart_items_wrapper.html(""),e.doc.items.length?e.doc.items.forEach(t=>{this.update_item_html(t)}):(this.make_no_items_placeholder(),this.highlight_checkout_btn(!0)),this.update_totals_section(e),e.doc.docstatus===1?(this.$totals_section.find(".checkout-btn").css("display","none"),this.$totals_section.find(".checkout-btn-held").css("display","none"),this.show_order_list_button?this.$totals_section.find(".checkout-btn-order").css("display","flex"):this.$totals_section.find(".checkout-btn-order").css("display","none"),this.$totals_section.find(".edit-cart-btn").css("display","none")):(this.show_checkout_button?this.$totals_section.find(".checkout-btn").css("display","flex"):this.$totals_section.find(".checkout-btn").css("display","none"),this.show_held_button?this.$totals_section.find(".checkout-btn-held").css("display","flex"):this.$totals_section.find(".checkout-btn-held").css("display","none"),this.show_order_list_button?this.$totals_section.find(".checkout-btn-order").css("display","flex"):this.$totals_section.find(".checkout-btn-order").css("display","none"),this.$totals_section.find(".edit-cart-btn").css("display","none")),this.toggle_component(!0)}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};frappe.provide("posnext.PointOfSale");posnext.PointOfSale.ItemDetails=class{constructor({wrapper:e,events:t,settings:i}){this.wrapper=e,this.events=t,this.hide_images=i.hide_images,this.allow_rate_change=i.allow_rate_change,this.allow_discount_change=i.allow_discount_change,this.custom_edit_rate_and_uom=i.custom_edit_rate_and_uom,this.current_item={},this.init_component()}init_component(){this.prepare_dom(),this.init_child_components(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append('<section class="item-details-container" id="item-details-container"></section>'),this.$component=this.wrapper.find(".item-details-container")}init_child_components(){this.$component.html(`<div class="item-details-header">
				<div class="label">${__("Item Detailss")}</div>
				<div class="close-btn">
					<svg width="32" height="32" viewBox="0 0 14 14" fill="none">
						<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>
					</svg>
				</div>
			</div>
			<div class="item-display">
				<div class="item-name-desc-price">
					<div class="item-name"></div>
					<div class="item-desc"></div>
					<div class="item-price"></div>
				</div>
				<div class="item-image"></div>
			</div>
			<div class="discount-section"></div>
			<div class="form-container"></div>
			<div class="serial-batch-container"></div>`),this.$item_name=this.$component.find(".item-name"),this.$item_description=this.$component.find(".item-desc"),this.$item_price=this.$component.find(".item-price"),this.$item_image=this.$component.find(".item-image"),this.$form_container=this.$component.find(".form-container"),this.$dicount_section=this.$component.find(".discount-section"),this.$serial_batch_container=this.$component.find(".serial-batch-container")}compare_with_current_item(e){return e&&e.name==this.current_item.name}async toggle_item_details_section(e){let t=!this.compare_with_current_item(e),i=!Boolean(e)||!t;(!i&&t||i)&&await this.validate_serial_batch_item(),this.custom_edit_rate_and_uom||(this.events.toggle_item_selector(!i),this.toggle_component(!i)),e&&t?(this.doctype=e.doctype,this.item_meta=frappe.get_meta(this.doctype),this.name=e.name,this.item_row=e,this.currency=this.events.get_frm().doc.currency,this.current_item=e,this.render_dom(e),this.render_discount_dom(e),this.render_form(e),this.events.highlight_cart_item(e)):this.current_item={}}validate_serial_batch_item(){let t=this.events.get_frm().doc.items.find(n=>n.name===this.name);if(!t)return;let i=t.has_serial_no,s=t.has_batch_no,o=!t.serial_and_batch_bundle;if(i&&o||s&&o)return frappe.show_alert({message:__("Item is removed since no serial / batch no selected."),indicator:"orange"}),frappe.utils.play_sound("cancel"),this.events.remove_item_from_cart()}render_dom(e){let{item_name:t,description:i,image:s,price_list_rate:o}=e;function n(){return i?(i=i.indexOf("...")===-1&&i.length>140?i.substr(0,139)+"...":i,i):""}this.$item_name.html(t),this.$item_description.html(n()),this.$item_price.html(format_currency(o,this.currency)),!this.hide_images&&s?this.$item_image.html(`<img
					onerror="cur_pos.item_details.handle_broken_image(this)"
					class="h-full" src="${s}"
					alt="${frappe.get_abbr(t)}"
					style="object-fit: cover;">`):this.$item_image.html(`<div class="item-abbr">${frappe.get_abbr(t)}</div>`)}handle_broken_image(e){let t=$(e).attr("alt");$(e).replaceWith(`<div class="item-abbr">${t}</div>`)}render_discount_dom(e){e.discount_percentage?(this.$dicount_section.html(`<div class="item-rate">${format_currency(e.price_list_rate,this.currency)}</div>
				<div class="item-discount">${e.discount_percentage}% off</div>`),this.$item_price.html(format_currency(e.rate,this.currency))):this.$dicount_section.html("")}render_form(e){let t=this.get_form_fields(e);this.$form_container.html(""),t.forEach((i,s)=>{this.$form_container.append(`<div class="${i}-control" data-fieldname="${i}"></div>`);let o=this.item_meta.fields.find(r=>r.fieldname===i);i==="discount_percentage"&&(o.label=__("Discount (%)"));let n=this;var a=[];frappe.db.get_doc("Item",n.current_item.item_code).then(r=>{a=r.uoms.map(c=>c.uom)}),this[`${i}_control`]=frappe.ui.form.make_control({df:v(u({},o),{onchange:function(){n.events.form_updated(n.current_item,i,this.value)},get_query:function(){if(i==="uom")return{filters:{name:["in",a]}}}}),parent:this.$form_container.find(`.${i}-control`),render_input:!0}),this[`${i}_control`].set_value(e[i])}),this.make_auto_serial_selection_btn(e),this.bind_custom_control_change_event()}get_form_fields(e){let t=["qty","uom","rate","conversion_factor","discount_percentage","warehouse","actual_qty","price_list_rate"];return e.has_serial_no&&t.push("serial_no"),e.has_batch_no&&t.push("batch_no"),t}make_auto_serial_selection_btn(e){if(e.has_serial_no||e.has_batch_no){let t=e.has_serial_no?__("Select Serial No"):__("Select Batch No");this.$form_container.append(`<div class="btn btn-sm btn-secondary auto-fetch-btn">${t}</div>`),this.$form_container.find(".serial_no-control").find("textarea").css("height","6rem")}}bind_custom_control_change_event(){let e=this;this.rate_control&&(this.rate_control.df.onchange=function(){(this.value||flt(this.value)===0)&&e.events.form_updated(e.current_item,"rate",this.value).then(()=>{let t=frappe.get_doc(e.doctype,e.name),i=e.events.get_frm().doc;e.$item_price.html(format_currency(t.rate,i.currency)),e.render_discount_dom(t)})},this.rate_control.df.read_only=!this.allow_rate_change,this.rate_control.refresh()),this.discount_percentage_control&&!this.allow_discount_change&&(this.discount_percentage_control.df.read_only=1,this.discount_percentage_control.refresh()),this.warehouse_control&&(this.warehouse_control.df.reqd=1,this.warehouse_control.df.onchange=function(){this.value&&e.events.form_updated(e.current_item,"warehouse",this.value).then(()=>{e.item_stock_map=e.events.get_item_stock_map();let t=e.item_stock_map[e.item_row.item_code][this.value][0],i=Boolean(e.item_stock_map[e.item_row.item_code][this.value][1]);if(t===void 0)e.events.get_available_stock(e.item_row.item_code,this.value).then(()=>{e.warehouse_control.set_value(this.value)});else if(t===0&&i){e.warehouse_control.set_value("");let s=e.item_row.item_code.bold(),o=this.value.bold();frappe.throw(__("Item Code: {0} is not available under warehouse {1}.",[s,o]))}e.actual_qty_control.set_value(t)})},this.warehouse_control.df.get_query=()=>({filters:{company:this.events.get_frm().doc.company}}),this.warehouse_control.refresh()),this.serial_no_control&&(this.serial_no_control.df.reqd=1,this.serial_no_control.df.onchange=async function(){!e.current_item.batch_no&&await e.auto_update_batch_no(),e.events.form_updated(e.current_item,"serial_no",this.value)},this.serial_no_control.refresh()),this.batch_no_control&&(this.batch_no_control.df.reqd=1,this.batch_no_control.df.get_query=()=>({query:"erpnext.controllers.queries.get_batch_no",filters:{item_code:e.item_row.item_code,warehouse:e.item_row.warehouse,posting_date:e.events.get_frm().doc.posting_date}}),this.batch_no_control.refresh()),this.uom_control&&(this.uom_control.df.onchange=function(){e.events.form_updated(e.current_item,"uom",this.value);let t=frappe.get_doc(e.doctype,e.name);e.conversion_factor_control.df.read_only=t.stock_uom==this.value,e.conversion_factor_control.refresh()}),frappe.model.on("POS Invoice Item","*",(t,i,s)=>{let o=this[`${t}_control`];this.compare_with_current_item(s)&&o&&o.get_value()!==i&&(o.set_value(i),cur_pos.update_cart_html(s))})}async auto_update_batch_no(){if(this.serial_no_control&&this.batch_no_control){let e=this.serial_no_control.get_value().split(`
`).filter(r=>r);if(!e.length)return;let i=(await frappe.db.get_list("Serial No",{filters:{name:["in",e]},fields:["batch_no","name"]})).reduce((r,c)=>(r[c.batch_no]||(r[c.batch_no]=[]),r[c.batch_no]=[...r[c.batch_no],c.name],r),{}),s=Object.keys(i)[0],o=i[s].join(`
`),n=e.length!==i[s].length;this.batch_no_control.get_value()!=s&&await this.batch_no_control.set_value(s),n&&(this.serial_no_control.set_value(o),this.qty_control.set_value(i[s].length),delete i[s],this.events.clone_new_batch_item_in_frm(i,this.current_item))}}bind_events(){this.bind_auto_serial_fetch_event(),this.bind_fields_to_numpad_fields(),this.$component.on("click",".close-btn",()=>{this.events.close_item_details()})}attach_shortcuts(){this.wrapper.find(".close-btn").attr("title","Esc"),frappe.ui.keys.on("escape",()=>{this.$component.is(":visible")&&this.events.close_item_details()})}bind_fields_to_numpad_fields(){let e=this;this.$form_container.on("click",".input-with-feedback",function(){let t=$(this).attr("data-fieldname");this.last_field_focused!=t&&(e.events.item_field_focused(t),this.last_field_focused=t)})}bind_auto_serial_fetch_event(){this.$form_container.on("click",".auto-fetch-btn",()=>{frappe.require("assets/erpnext/js/utils/serial_no_batch_selector.js",()=>{let e=this.events.get_frm(),t=this.item_row;t.type_of_transaction="Outward",new erpnext.SerialBatchPackageSelector(e,t,i=>{i&&frappe.model.set_value(t.doctype,t.name,{serial_and_batch_bundle:i.name,qty:Math.abs(i.total_qty)})})})})}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};frappe.provide("posnext.PointOfSale");posnext.PointOfSale.NumberPad=class{constructor({wrapper:e,events:t,cols:i,keys:s,css_classes:o,fieldnames_map:n}){this.wrapper=e,this.events=t,this.cols=i,this.keys=s,this.css_classes=o||[],this.fieldnames=n||{},this.init_component()}init_component(){this.prepare_dom(),this.bind_events()}prepare_dom(){let{cols:e,keys:t,css_classes:i,fieldnames:s}=this;function o(){return t.reduce((n,a,r)=>n+a.reduce((c,m,l)=>{let d=i&&i[r]?i[r][l]:"",_=s&&s[m]?s[m]:typeof m=="string"?frappe.scrub(m):m;return c+`<div class="numpad-btn ${d}" data-button-value="${_}">${__(m)}</div>`},""),"")}this.wrapper.html(`<div class="numpad-container">
				${o()}
			</div>`)}bind_events(){let e=this;this.wrapper.on("click",".numpad-btn",function(){let t=$(this);e.events.numpad_event(t)})}};frappe.provide("posnext.PointOfSale");posnext.PointOfSale.Payment=class{constructor({events:e,wrapper:t,settings:i}){this.wrapper=t,this.events=e,this.custom_show_sales_man=i.custom_show_sales_man,this.custom_show_additional_note=i.custom_show_additional_note,this.custom_edit_rate=i.custom_edit_rate_and_uom,this.custom_show_credit_sales=i.custom_show_credit_sales,this.default_payment=i.default_payment,this.current_payments=[],this.init_component()}init_component(){this.prepare_dom(),this.initialize_numpad(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append(`<section class="payment-container">
				<div class="section-label payment-section">${__("Payment Method")}</div>
				<div class="payment-modes"></div>
				<div class="fields-numpad-container">
					<div class="fields-section">
						<div class="section-label">${__("Additional Information")}</div>
						<div class="invoice-fields"></div>
					</div>
					<div class="number-pad"></div>
				</div>
				<div class="totals-section">
					<div class="totals"></div>
				</div>
				<div class="submit-order-btn">${__("Complete Order")}</div>
			</section>`),this.$component=this.wrapper.find(".payment-container"),this.$payment_modes=this.$component.find(".payment-modes"),this.$totals_section=this.$component.find(".totals-section"),this.$totals=this.$component.find(".totals"),this.$numpad=this.$component.find(".number-pad"),this.$invoice_fields_section=this.$component.find(".fields-section")}make_invoice_fields_control(){var e=this;let t=[];if(this.custom_show_credit_sales&&t.push({fieldname:"custom_credit_sales",label:"Credit Sales",fieldtype:"Check"}),this.custom_show_sales_man&&t.push({fieldname:"sales_person",label:"Sales Man",fieldtype:"Link",options:"Sales Person"}),this.custom_show_additional_note&&t.push({fieldname:"remarks",label:"Additional Note",fieldtype:"Small Text"}),!t.length)return;this.$invoice_fields=this.$invoice_fields_section.find(".invoice-fields"),this.$invoice_fields.html("");let i=this.events.get_frm();e.current_payments=i.doc.payments,t.forEach(s=>{this.$invoice_fields.append(`<div class="invoice_detail_field ${s.fieldname}-field" data-fieldname="${s.fieldname}"></div>`);let o={onchange:function(){this.df.fieldname==="sales_person"?(i.clear_table("sales_team"),cur_frm.add_child("sales_team",{sales_person:this.get_value(),allocated_percentage:100})):(this.df.fieldname==="custom_credit_sales"&&(this.get_value()?i.doc.payments.forEach(n=>{let a=n.mode_of_payment.replace(/ +/g,"_").toLowerCase();e[`${a}_control`].set_value(0)}):(console.log(e.current_payments),e.current_payments.forEach(n=>{if(n.mode_of_payment===e.default_payment){let a=n.mode_of_payment.replace(/ +/g,"_").toLowerCase();e[`${a}_control`].set_value(i.doc.grand_total)}}))),i.set_value(this.df.fieldname,this.get_value()))}};s.fieldtype=="Button"&&(o={click:function(){i.script_manager.has_handlers(s.fieldname,i.doc.doctype)&&i.script_manager.trigger(s.fieldname,i.doc.doctype,i.doc.docname)}}),this[`${s.fieldname}_field`]=frappe.ui.form.make_control({df:u(u({},s),o),parent:this.$invoice_fields.find(`.${s.fieldname}-field`),render_input:!0}),s.fieldname!=="remarks"&&this[`${s.fieldname}_field`].set_value(i.doc[s.fieldname])})}initialize_numpad(){let e=this;this.number_pad=new posnext.PointOfSale.NumberPad({wrapper:this.$numpad,events:{numpad_event:function(t){e.on_numpad_clicked(t)}},cols:3,keys:[[1,2,3],[4,5,6],[7,8,9],[".",0,"Delete"]]}),this.numpad_value=""}on_numpad_clicked(e){let t=e.attr("data-button-value");i(e),this.numpad_value=t==="delete"?this.numpad_value.slice(0,-1):this.numpad_value+t,this.selected_mode.$input.get(0).focus(),this.selected_mode.set_value(this.numpad_value);function i(s){s.addClass("shadow-base-inner bg-selected"),setTimeout(()=>{s.removeClass("shadow-base-inner bg-selected")},100)}}bind_events(){let e=this;this.$payment_modes.on("click",".mode-of-payment",function(t){let i=$(this);if(!$(t.target).is(i))return;let s=i.offset().left-e.$payment_modes.offset().left+e.$payment_modes.scrollLeft();e.$payment_modes.animate({scrollLeft:s});let o=i.attr("data-mode");$(".mode-of-payment-control").css("display","none"),$(".cash-shortcuts").css("display","none"),e.$payment_modes.find(".pay-amount").css("display","inline"),e.$payment_modes.find(".loyalty-amount-name").css("display","none"),$(".mode-of-payment").removeClass("border-primary"),i.hasClass("border-primary")?(i.removeClass("border-primary"),e.selected_mode=""):(i.addClass("border-primary"),i.find(".mode-of-payment-control").css("display","flex"),i.find(".cash-shortcuts").css("display","grid"),e.$payment_modes.find(`.${o}-amount`).css("display","none"),e.$payment_modes.find(`.${o}-name`).css("display","inline"),e.selected_mode=e[`${o}_control`],e.selected_mode&&e.selected_mode.$input.get(0).focus(),e.auto_set_remaining_amount())}),frappe.ui.form.on("POS Invoice","contact_mobile",t=>{var o;let i=t.doc.contact_mobile,s=$((o=this.request_for_payment_field)==null?void 0:o.$input[0]);i?s.removeClass("btn-default").addClass("btn-primary"):s.removeClass("btn-primary").addClass("btn-default")}),frappe.ui.form.on("POS Invoice","coupon_code",t=>{t.doc.coupon_code&&!t.applying_pos_coupon_code&&(t.doc.ignore_pricing_rule?t.doc.ignore_pricing_rule&&frappe.show_alert({message:__("Ignore Pricing Rule is enabled. Cannot apply coupon code."),indicator:"orange"}):(t.applying_pos_coupon_code=!0,frappe.run_serially([()=>t.doc.ignore_pricing_rule=1,()=>t.trigger("ignore_pricing_rule"),()=>t.doc.ignore_pricing_rule=0,()=>t.trigger("apply_pricing_rule"),()=>t.save(),()=>this.update_totals_section(t.doc),()=>t.applying_pos_coupon_code=!1])))}),this.setup_listener_for_payments(),this.$payment_modes.on("click",".shortcut",function(){let t=$(this).attr("data-value");e.selected_mode.set_value(t)}),this.$component.on("click",".submit-order-btn",()=>{let t=this.events.get_frm().doc,i=t.paid_amount;cur_frm.doc.custom_credit_sales&&this.custom_show_credit_sales&&(cur_frm.clear_table("payments"),i=0);let s=t.items;if((i==0||!s.length)&&!this.custom_show_credit_sales){let o=s.length?__("You cannot submit the order without payment."):__("You cannot submit empty order.");frappe.show_alert({message:o,indicator:"orange"}),frappe.utils.play_sound("error");return}this.events.submit_invoice()}),frappe.ui.form.on("POS Invoice","paid_amount",t=>{this.update_totals_section(t.doc);let i=!this.$payment_modes.find(".cash-shortcuts").is(":visible");this.attach_cash_shortcuts(t.doc),!i&&this.$payment_modes.find(".cash-shortcuts").css("display","grid"),this.render_payment_mode_dom()}),frappe.ui.form.on("POS Invoice","loyalty_amount",t=>{let i=format_currency(t.doc.loyalty_amount,t.doc.currency);this.$payment_modes.find(".loyalty-amount-amount").html(i)}),frappe.ui.form.on("Sales Invoice Payment","amount",(t,i,s)=>{let o=locals[i][s],n=o.mode_of_payment.replace(/ +/g,"_").toLowerCase();this[`${n}_control`]&&this[`${n}_control`].get_value()!=o.amount&&this[`${n}_control`].set_value(o.amount)})}setup_listener_for_payments(){frappe.realtime.on("process_phone_payment",e=>{let t=this.events.get_frm().doc,{response:i,amount:s,success:o,failure_message:n}=e,a,r;if(o){r=__("Payment Received");let c=cint(frappe.sys_defaults.disable_rounded_total)?t.grand_total:t.rounded_total;s>=c?(frappe.dom.unfreeze(),a=__("Payment of {0} received successfully.",[format_currency(s,t.currency,0)]),this.events.submit_invoice(),cur_frm.reload_doc()):a=__("Payment of {0} received successfully. Waiting for other requests to complete...",[format_currency(s,t.currency,0)])}else n&&(a=n,r=__("Payment Failed"));frappe.msgprint({message:a,title:r})})}auto_set_remaining_amount(){let e=this.events.get_frm().doc,i=(cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total)-e.paid_amount;!(this.selected_mode?this.selected_mode.get_value():void 0)&&i>0&&this.selected_mode&&this.selected_mode.set_value(i)}attach_shortcuts(){let e=frappe.utils.is_mac()?"\u2318":"Ctrl";this.$component.find(".submit-order-btn").attr("title",`${e}+Enter`),frappe.ui.keys.on("ctrl+enter",()=>{let t=this.$component.is(":visible"),i=this.$payment_modes.find(".border-primary");t&&i.length&&this.$component.find(".submit-order-btn").click()}),frappe.ui.keys.add_shortcut({shortcut:"tab",action:()=>{let t=this.$component.is(":visible"),i=this.$payment_modes.find(".border-primary");if(i=i.length?i.attr("data-mode"):void 0,!i)return;let s=Array.from(this.$payment_modes.find(".mode-of-payment")).map(r=>$(r).attr("data-mode")),o=s.indexOf(i),n=(o+1)%s.length,a=this.$payment_modes.find(`.mode-of-payment[data-mode="${s[n]}"]`);t&&o!=n&&a.click()},condition:()=>this.$component.is(":visible")&&this.$payment_modes.find(".border-primary").length,description:__("Switch Between Payment Modes"),ignore_inputs:!0,page:cur_page.page.page})}toggle_numpad(){}render_payment_section(){this.render_payment_mode_dom(),this.make_invoice_fields_control(),this.update_totals_section(),this.focus_on_default_mop()}after_render(){let e=this.events.get_frm();e.script_manager.trigger("after_payment_render",e.doc.doctype,e.doc.docname)}edit_cart(){if(this.custom_edit_rate){let e=document.getElementById("customer-cart-container2");e.style.gridColumn="span 5 / span 5"}this.events.toggle_other_sections(!1),this.toggle_component(!1)}checkout(){this.events.toggle_other_sections(!0),this.toggle_component(!0),this.render_payment_section(),this.after_render()}toggle_remarks_control(){this.$remarks.find(".frappe-control").length?this.$remarks.html("+ Add Remark"):(this.$remarks.html(""),this.remark_control=frappe.ui.form.make_control({df:{label:__("Remark"),fieldtype:"Data",onchange:function(){}},parent:this.$totals_section.find(".remarks"),render_input:!0}),this.remark_control.set_value(""))}render_payment_mode_dom(){let e=this.events.get_frm().doc,t=e.payments,i=e.currency;this.$payment_modes.html(`${t.map((s,o)=>{let n=s.mode_of_payment.replace(/ +/g,"_").toLowerCase(),a=s.type,r=o%2===0?"pr-2":"pl-2",c=s.amount>0?format_currency(s.amount,i):"";return`
					<div class="payment-mode-wrapper">
						<div class="mode-of-payment" data-mode="${n}" data-payment-type="${a}">
							${s.mode_of_payment}
							<div class="${n}-amount pay-amount">${c}</div>
							<div class="${n} mode-of-payment-control"></div>
						</div>
					</div>
				`}).join("")}`),this.current_payments=t,t.forEach(s=>{let o=s.mode_of_payment.replace(/ +/g,"_").toLowerCase(),n=this;this[`${o}_control`]=frappe.ui.form.make_control({df:{label:s.mode_of_payment,fieldtype:"Currency",placeholder:__("Enter {0} amount.",[s.mode_of_payment]),onchange:function(){if(console.log(s.doctype),console.log(s.name),frappe.model.get_value(s.doctype,s.name,"amount")!=this.value){frappe.model.set_value(s.doctype,s.name,"amount",flt(this.value)).then(()=>n.update_totals_section());let r=format_currency(this.value,i);n.$payment_modes.find(`.${o}-amount`).html(r)}}},parent:this.$payment_modes.find(`.${o}.mode-of-payment-control`),render_input:!0}),this[`${o}_control`].toggle_label(!1),this[`${o}_control`].set_value(s.amount)}),this.render_loyalty_points_payment_mode(),this.attach_cash_shortcuts(e)}focus_on_default_mop(){this.events.get_frm().doc.payments.forEach(i=>{let s=i.mode_of_payment.replace(/ +/g,"_").toLowerCase();i.default&&setTimeout(()=>{this.$payment_modes.find(`.${s}.mode-of-payment-control`).parent().click()},500)})}attach_cash_shortcuts(e){let t=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,i=e.currency,s=this.get_cash_shortcuts(flt(t));this.$payment_modes.find(".cash-shortcuts").remove();let o=s.map(n=>`<div class="shortcut" data-value="${n}">${format_currency(n,i,0)}</div>`).join("");this.$payment_modes.find('[data-payment-type="Cash"]').find(".mode-of-payment-control").after(`<div class="cash-shortcuts">${o}</div>`)}get_cash_shortcuts(e){let t=[1,5,10],i=String(Math.round(e)).length;t=t.map(o=>o*10**(i-2));let s=(o,n)=>{let a=Math.ceil(o/n)*n;return a===o?a+n:a};return t.reduce((o,n)=>{let a=s(e,n);return a=o.indexOf(a)!=-1?a+n:a,[...o,a]},[])}render_loyalty_points_payment_mode(){let e=this,t=this.events.get_frm().doc,{loyalty_program:i,loyalty_points:s,conversion_factor:o}=this.events.get_customer_details();if(this.$payment_modes.find('.mode-of-payment[data-mode="loyalty-amount"]').parent().remove(),!i)return;let n,a,r;s?(r=flt(flt(s)*flt(o),precision("loyalty_amount",t)),n=__("You can redeem upto {0}.",[format_currency(r)]),a=!1):(n=__("You don't have enough points to redeem."),a=!0);let c=this.$payment_modes.children().length%2===0?"pr-2":"pl-2",m=t.loyalty_amount>0?format_currency(t.loyalty_amount,t.currency):"";this.$payment_modes.append(`<div class="payment-mode-wrapper">
				<div class="mode-of-payment loyalty-card" data-mode="loyalty-amount" data-payment-type="loyalty-amount">
					Redeem Loyalty Points
					<div class="loyalty-amount-amount pay-amount">${m}</div>
					<div class="loyalty-amount-name">${i}</div>
					<div class="loyalty-amount mode-of-payment-control"></div>
				</div>
			</div>`),this["loyalty-amount_control"]=frappe.ui.form.make_control({df:{label:__("Redeem Loyalty Points"),fieldtype:"Currency",placeholder:__("Enter amount to be redeemed."),options:"company:currency",read_only:a,onchange:async function(){if(!s)return;if(this.value>r){frappe.show_alert({message:__("You cannot redeem more than {0}.",[format_currency(r)]),indicator:"red"}),frappe.utils.play_sound("submit"),e["loyalty-amount_control"].set_value(0);return}let l=this.value>0?1:0;await frappe.model.set_value(t.doctype,t.name,"redeem_loyalty_points",l),frappe.model.set_value(t.doctype,t.name,"loyalty_points",parseInt(this.value/o))},description:n},parent:this.$payment_modes.find(".loyalty-amount.mode-of-payment-control"),render_input:!0}),this["loyalty-amount_control"].toggle_label(!1)}render_add_payment_method_dom(){this.events.get_frm().doc.docstatus===0&&this.$payment_modes.append(`<div class="w-full pr-2">
					<div class="add-mode-of-payment w-half text-grey mb-4 no-select pointer">+ Add Payment Method</div>
				</div>`)}update_totals_section(e){e||(e=this.events.get_frm().doc);let t=e.paid_amount;cur_frm.doc.custom_credit_sales;let i=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,s=i-e.paid_amount,o=e.change_amount||s<=0?-1*s:void 0,n=e.currency,a=o?__("Change"):__("To Be Paid");this.$totals.html(`<div class="col">
				<div class="total-label">${__("Grand Total")}</div>
				<div class="value">${format_currency(i,n)}</div>
			</div>
			<div class="seperator-y"></div>
			<div class="col">
				<div class="total-label">${__("Paid Amount")}</div>
				<div class="value">${format_currency(t,n)}</div>
			</div>
			<div class="seperator-y"></div>
			<div class="col">
				<div class="total-label">${a}</div>
				<div class="value">${format_currency(o||s,n)}</div>
			</div>`)}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};frappe.provide("posnext.PointOfSale");var x=[];posnext.PointOfSale.PastOrderList=class{constructor({wrapper:e,events:t,settings:i}){this.wrapper=e,this.events=t,this.pos_profile=i.name,this.custom_filter_order_list_by_profile=i.custom_filter_order_list_by_profile,this.init_component()}init_component(){this.prepare_dom(),this.make_filter_section(),this.bind_events()}prepare_dom(){this.wrapper.append(`<section class="past-order-list">
				<div class="filter-section">
					<div class="label back" style="font-size: 13px ">
						<a>
							<svg class="es-line" style="width: 13px;height: 13px">
								<use class="" href="#es-line-left-chevron"></use></svg> Back
						</a>
					</div>
					<br>
					<div class="label">${__("Recent Orders")}</div>
					<div class="search-field"></div>
					<div class="status-field"></div>
				</div>
				<div class="invoices-container"></div>
			</section>`),this.$component=this.wrapper.find(".past-order-list"),this.$invoices_container=this.$component.find(".invoices-container")}bind_events(){this.search_field.$input.on("input",t=>{clearTimeout(this.last_search),this.last_search=setTimeout(()=>{let i=t.target.value;this.refresh_list(i,this.status_field.get_value())},300)});let e=this;this.$invoices_container.on("click",".invoice-wrapper",function(){let t=unescape($(this).attr("data-invoice-name"));e.events.open_invoice_data(t)}),this.$component.on("click",".back",function(){e.events.previous_screen()})}make_filter_section(){let e=this;this.search_field=frappe.ui.form.make_control({df:{label:__("Search"),fieldtype:"Data",placeholder:__("Search by invoice id or customer name")},parent:this.$component.find(".search-field"),render_input:!0}),this.status_field=frappe.ui.form.make_control({df:{label:__("Invoice Status"),fieldtype:"Select",options:`Draft
Paid
Unpaid
Return`,placeholder:__("Filter by invoice status"),onchange:function(){e.$component.is(":visible")&&e.refresh_list()}},parent:this.$component.find(".status-field"),render_input:!0}),this.search_field.toggle_label(!1),this.status_field.toggle_label(!1),this.status_field.set_value("Draft")}refresh_list(){frappe.dom.freeze(),this.events.reset_summary();let e=this.search_field.get_value(),t=this.status_field.get_value(),i=this.pos_profile;this.$invoices_container.html("");let s={search_term:e,status:t};return this.custom_filter_order_list_by_profile&&(s={search_term:e,status:t,pos_profile:i}),frappe.call({method:"posnext.posnext.page.posnext.point_of_sale.get_past_order_list",freeze:!0,args:s,callback:o=>{frappe.dom.unfreeze(),x=o.message,o.message.forEach(n=>{let a=this.get_invoice_html(n);this.$invoices_container.append(a)})}})}get_invoice_html(e){let t=moment(e.posting_date+" "+e.posting_time).format("Do MMMM, h:mma");return`<div class="invoice-wrapper" data-invoice-name="${escape(e.name)}">
				<div class="invoice-name-date">
					<div class="invoice-name">${e.name}</div>
					<div class="invoice-date">
						<svg class="mr-2" width="12" height="12" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
							<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
						</svg>
						${frappe.ellipsis(e.customer,20)}
					</div>
				</div>
				<div class="invoice-total-status">
					<div class="invoice-total">${format_currency(e.grand_total,e.currency,0)||0}</div>
					<div class="invoice-date">${t}</div>
				</div>
			</div>
			<div class="seperator"></div>`}toggle_component(e){frappe.run_serially([()=>e?this.$component.css("display","flex")&&this.refresh_list():this.$component.css("display","none"),()=>this.events.open_invoice_data(x[0].name)])}};frappe.provide("posnext.PointOfSale");posnext.PointOfSale.PastOrderSummary=class{constructor({wrapper:e,pos_profile:t,events:i}){this.wrapper=e,this.pos_profile=t,this.events=i,this.init_component()}init_component(){this.prepare_dom(),this.init_email_print_dialog(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append(`<section class="past-order-summary">
				<div class="no-summary-placeholder">
					${__("Select an invoice to load summary data")}
				</div>
				<div class="invoice-summary-wrapper" >
					<div class="abs-container" >
						<div class="upper-section"></div>
						<div class="label">${__("Items")}</div>
						<div class="items-container summary-container"></div>
						<div class="label">${__("Totals")}</div>
						<div class="totals-container summary-container"></div>
						<div class="label">${__("Payments")}</div>
						<div class="payments-container summary-container"></div>
						<div class="summary-btns"></div>
					</div>
				</div>
			</section>`),this.$component=this.wrapper.find(".past-order-summary"),this.$summary_wrapper=this.$component.find(".invoice-summary-wrapper"),this.$summary_container=this.$component.find(".abs-container"),this.$upper_section=this.$summary_container.find(".upper-section"),this.$items_container=this.$summary_container.find(".items-container"),this.$totals_container=this.$summary_container.find(".totals-container"),this.$payment_container=this.$summary_container.find(".payments-container"),this.$summary_btns=this.$summary_container.find(".summary-btns")}init_email_print_dialog(){let e=new frappe.ui.Dialog({title:"Email Receipt",fields:[{fieldname:"email_id",fieldtype:"Data",options:"Email",label:"Email ID",reqd:1},{fieldname:"content",fieldtype:"Small Text",label:"Message (if any)"}],primary_action:()=>{this.send_email()},primary_action_label:__("Send")});this.email_dialog=e;let t=new frappe.ui.Dialog({title:"Print Receipt",fields:[{fieldname:"print",fieldtype:"Data",label:"Print Preview"}],primary_action:()=>{this.print_receipt()},primary_action_label:__("Print")});this.print_dialog=t}get_upper_section_html(e){let{status:t}=e,i="";return in_list(["Paid","Consolidated"],t)&&(i="green"),t==="Draft"&&(i="red"),t==="Return"&&(i="grey"),`<div class="left-section">
					<div class="customer-name">${e.customer}</div>
					<div class="customer-email">${this.customer_email}</div>
					<div class="cashier">${__("Sold by")}: ${e.owner}</div>
				</div>
				<div class="right-section">
					<div class="paid-amount">${format_currency(e.paid_amount,e.currency)}</div>
					<div class="invoice-name">${e.name}</div>
					<span class="indicator-pill whitespace-nowrap ${i}"><span>${e.status}</span></span>
				</div>`}get_item_html(e,t){return`<div class="item-row-wrapper">
					<div class="item-name">${t.item_name}</div>
					<div class="item-qty">${t.qty||0} ${t.uom}</div>
					<div class="item-rate-disc">${i()}</div>
				</div>`;function i(){return t.rate&&t.price_list_rate&&t.rate!==t.price_list_rate?`<span class="item-disc">(${t.discount_percentage}% off)</span>
						<div class="item-rate">${format_currency(t.rate,e.currency)}</div>`:`<div class="item-rate">${format_currency(t.price_list_rate||t.rate,e.currency)}</div>`}}get_discount_html(e){return e.discount_amount?`<div class="summary-row-wrapper">
						<div>Discount (${e.additional_discount_percentage} %)</div>
						<div>${format_currency(e.discount_amount,e.currency)}</div>
					</div>`:""}get_net_total_html(e){return`<div class="summary-row-wrapper">
					<div>${__("Net Total")}</div>
					<div>${format_currency(e.net_total,e.currency)}</div>
				</div>`}get_taxes_html(e){return e.taxes.length?`<div class="taxes-wrapper">${e.taxes.map(i=>`
				<div class="tax-row">
					<div class="tax-label">${/[0-9]+/.test(i.description)?i.description:i.rate!=0?`${i.description} @ ${i.rate}%`:i.description}</div>
					<div class="tax-value">${format_currency(i.tax_amount_after_discount_amount,e.currency)}</div>
				</div>
			`).join("")}</div>`:""}get_grand_total_html(e){return`<div class="summary-row-wrapper grand-total">
					<div>${__("Grand Total")}</div>
					<div>${format_currency(e.grand_total,e.currency)}</div>
				</div>`}get_payment_html(e,t){return`<div class="summary-row-wrapper payments">
					<div>${__(t.mode_of_payment)}</div>
					<div>${format_currency(t.amount,e.currency)}</div>
				</div>`}bind_events(){this.$summary_container.on("click",".return-btn",()=>{this.events.process_return(this.doc.name),this.toggle_component(!1),this.$component.find(".no-summary-placeholder").css("display","flex"),this.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".edit-btn",()=>{this.events.edit_order(this.doc.name),this.toggle_component(!1),this.$component.find(".no-summary-placeholder").css("display","flex"),this.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".delete-btn",()=>{this.events.delete_order(this.doc.name),this.show_summary_placeholder()}),this.$summary_container.on("click",".send-btn",()=>{console.log(this.pos_profile);var t=this.pos_profile.custom_whatsapp_field_names.map(s=>this.doc[s.field_names.toString()]);console.log(t),console.log(t.join(","));var i="https://wa.me/"+this.doc.customer+"?text=";i+=e(this.pos_profile.custom_whatsapp_message,t),console.log(i),frappe.call({method:"posnext.posnext.page.posnext.point_of_sale.generate_pdf_and_save",args:{docname:this.doc.name,doctype:this.doc.doctype,print_format:this.pos_profile.print_format},freeze:!0,freeze_message:"Creating file then send to whatsapp thru link....",callback:function(s){i+=`Please Find your invoice here 
 `+window.origin+s.message.file_url,window.open(i)}})});function e(t,i){return t.replace(/{(\d+)}/g,function(s,o){return typeof i[o]!="undefined"?i[o]:s})}this.$summary_container.on("click",".new-btn",()=>{this.events.new_order(),this.toggle_component(!1),this.$component.find(".no-summary-placeholder").css("display","flex"),this.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".email-btn",()=>{this.email_dialog.fields_dict.email_id.set_value(this.customer_email),this.email_dialog.show()}),this.$summary_container.on("click",".print-btn",()=>{this.print_receipt()})}print_receipt(){let e=this.events.get_frm();frappe.utils.print(this.doc.doctype,this.doc.name,e.pos_print_format,this.doc.letter_head,this.doc.language||frappe.boot.lang)}attach_shortcuts(){let e=frappe.utils.is_mac()?"\u2318":"Ctrl";this.$summary_container.find(".print-btn").attr("title",`${e}+P`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+p",action:()=>this.$summary_container.find(".print-btn").click(),condition:()=>this.$component.is(":visible")&&this.$summary_container.find(".print-btn").is(":visible"),description:__("Print Receipt"),page:cur_page.page.page}),this.$summary_container.find(".new-btn").attr("title",`${e}+Enter`),frappe.ui.keys.on("ctrl+enter",()=>{this.$component.is(":visible")&&this.$summary_container.find(".new-btn").is(":visible")&&this.$summary_container.find(".new-btn").click()}),this.$summary_container.find(".edit-btn").attr("title",`${e}+E`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+e",action:()=>this.$summary_container.find(".edit-btn").click(),condition:()=>this.$component.is(":visible")&&this.$summary_container.find(".edit-btn").is(":visible"),description:__("Edit Receipt"),page:cur_page.page.page})}send_email(){let e=this.events.get_frm(),t=this.email_dialog.get_values().email_id,i=this.email_dialog.get_values().content,s=this.doc||e.doc,o=e.pos_print_format;frappe.call({method:"frappe.core.doctype.communication.email.make",args:{recipients:t,subject:__(e.meta.name)+": "+s.name,content:i||__(e.meta.name)+": "+s.name,doctype:s.doctype,name:s.name,send_email:1,print_format:o,sender_full_name:frappe.user.full_name(),_lang:s.language},callback:n=>{n.exc?frappe.msgprint(__("There were errors while sending email. Please try again.")):(frappe.utils.play_sound("email"),n.message.emails_not_sent_to?frappe.msgprint(__("Email not sent to {0} (unsubscribed / disabled)",[frappe.utils.escape_html(n.message.emails_not_sent_to)])):frappe.show_alert({message:__("Email sent successfully."),indicator:"green"}),this.email_dialog.hide())}})}add_summary_btns(e){this.$summary_btns.html(""),e.forEach(t=>{t.condition&&t.visible_btns.forEach(i=>{let s=i.split(" ")[0].toLowerCase(),o=__(i);this.$summary_btns.append(`<div class="summary-btn btn btn-default ${s}-btn">${o}</div>`)})}),this.$summary_btns.children().last().removeClass("mr-4")}toggle_summary_placeholder(e){e?(this.$summary_wrapper.css("display","none"),this.$component.find(".no-summary-placeholder").css("display","flex")):(this.$summary_wrapper.css("display","flex"),this.$component.find(".no-summary-placeholder").css("display","none"))}get_condition_btn_map(e){return e?[{condition:!0,visible_btns:["Print Receipt","Email Receipt","Send Whatsapp","New Order"]}]:[{condition:this.doc.docstatus===0,visible_btns:["Print Receipt","Edit Order","Delete Order","Send Whatsapp"]},{condition:!this.doc.is_return&&this.doc.docstatus===1,visible_btns:["Print Receipt","Email Receipt","Return","Send Whatsapp"]},{condition:this.doc.is_return&&this.doc.docstatus===1,visible_btns:["Print Receipt","Email Receipt","Send Whatsapp"]}]}load_summary_of(e,t=!1){t?this.$component.css("grid-column","span 10 / span 10"):this.$component.css("grid-column","span 6 / span 6"),this.toggle_summary_placeholder(!1),this.doc=e,this.attach_document_info(e),this.attach_items_info(e),this.attach_totals_info(e),this.attach_payments_info(e);let i=this.get_condition_btn_map(t);this.add_summary_btns(i),this.$summary_wrapper.css("width",t?"35%":"60%")}attach_document_info(e){frappe.db.get_value("Customer",this.doc.customer,"email_id").then(({message:t})=>{this.customer_email=t.email_id||"";let i=this.get_upper_section_html(e);this.$upper_section.html(i)})}attach_items_info(e){this.$items_container.html(""),e.items.forEach(t=>{let i=this.get_item_html(e,t);this.$items_container.append(i),this.set_dynamic_rate_header_width()})}set_dynamic_rate_header_width(){let e=Array.from(this.$items_container.find(".item-rate-disc"));this.$items_container.find(".item-rate-disc").css("width","");let t=e.reduce((i,s)=>($(s).width()>i&&(i=$(s).width()),i),0);t+=1,t==1&&(t=""),this.$items_container.find(".item-rate-disc").css("width",t)}attach_payments_info(e){if(this.$payment_container.html(""),e.payments.forEach(t=>{if(t.amount){let i=this.get_payment_html(e,t);this.$payment_container.append(i)}}),e.redeem_loyalty_points&&e.loyalty_amount){let t=this.get_payment_html(e,{mode_of_payment:"Loyalty Points",amount:e.loyalty_amount});this.$payment_container.append(t)}}attach_totals_info(e){this.$totals_container.html("");let t=this.get_net_total_html(e),i=this.get_taxes_html(e),s=this.get_discount_html(e),o=this.get_grand_total_html(e);this.$totals_container.append(t),this.$totals_container.append(i),this.$totals_container.append(s),this.$totals_container.append(o)}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};})();
//# sourceMappingURL=posnext.bundle.EDUF27JG.js.map
